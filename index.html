<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>90 Hari Transformasi Diri - AI Companion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Semua style CSS tetap sama seperti sebelumnya */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --danger-color: #e63946;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-color: #333333;
            --sidebar-width: 260px;
        }

        .dark-mode {
            --primary-color: #5a7dff;
            --secondary-color: #4a1fb8;
            --light-color: #2d3748;
            --dark-color: #f8f9fa;
            --gray-color: #a0aec0;
            --card-bg: #2d3748;
            --body-bg: #1a202c;
            --text-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo span {
            color: var(--warning-color);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            height: calc(100vh - 70px);
            position: sticky;
            top: 70px;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 90;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .username {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-streak {
            font-size: 0.8rem;
            color: var(--gray-color);
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .streak-fire {
            color: #ff6b35;
            margin-right: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-color);
            text-decoration: none;
            border-left: 4px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        .nav-item i {
            margin-right: 15px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: auto;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 10px 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-width: 100%;
        }

        .page-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.2);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background-color: rgba(67, 97, 238, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        /* Progress */
        .progress-container {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 5px;
            width: 0%;
            transition: width 1s ease;
        }

        /* Streak Animation */
        .streak-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .streak-count {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            position: relative;
        }

        .fire-animation {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 2rem;
            animation: fire 1.5s infinite alternate;
        }

        @keyframes fire {
            0% { 
                transform: scale(1) rotate(-10deg); 
                color: #ff6b35; 
                filter: drop-shadow(0 0 5px rgba(255, 107, 53, 0.7));
            }
            50% { 
                transform: scale(1.3) rotate(0deg); 
                color: #ffa500; 
                filter: drop-shadow(0 0 10px rgba(255, 165, 0, 0.9));
            }
            100% { 
                transform: scale(1.2) rotate(10deg); 
                color: #ffff00; 
                filter: drop-shadow(0 0 15px rgba(255, 255, 0, 0.8));
            }
        }

        .streak-label {
            font-size: 1rem;
            color: var(--gray-color);
        }

        .streak-subtext {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 10px;
        }

        /* Checklist */
        .checklist {
            margin-top: 20px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .checklist-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid var(--gray-color);
            margin-right: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .checklist-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .checklist-text {
            flex: 1;
        }

        .checklist-time {
            font-size: 0.8rem;
            color: var(--gray-color);
        }

        /* AI Chat */
        .ai-chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .ai-chat-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 15px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-ai {
            align-self: flex-start;
            background-color: var(--light-color);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .ai-chat-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            resize: none;
            max-height: 100px;
            min-height: 60px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .chat-send {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 60px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .chat-send:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        /* Countdown */
        .countdown-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .countdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-width: 100px;
        }

        .countdown-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .countdown-label {
            font-size: 0.9rem;
            color: var(--gray-color);
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* Tabs */
        .tab-container {
            margin-bottom: 30px;
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--primary-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px;
        }

        /* Loading */
        /* Loading Animation - AI Typing */
.loading {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 20px;
}

.loading-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--primary-color);
    animation: typing 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.loading-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Typing Indicator untuk AI Message */
.ai-typing {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    background-color: var(--light-color);
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    max-width: 85%;
    align-self: flex-start;
    margin-bottom: 5px;
    animation: fadeIn 0.3s ease;
}

.ai-typing-text {
    font-size: 0.9rem;
    color: var(--gray-color);
    font-style: italic;
}

.ai-typing-dots {
    display: flex;
    gap: 4px;
}

.ai-typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--gray-color);
    animation: typingDots 1.5s infinite ease-in-out both;
}

.ai-typing-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.ai-typing-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typingDots {
    0%, 80%, 100% {
        transform: translateY(0);
        opacity: 0.3;
    }
    40% {
        transform: translateY(-5px);
        opacity: 1;
    }
}

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-warning {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .w-100 { width: 100%; }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 70px;
                height: calc(100vh - 70px);
                z-index: 100;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }
            
            .logo {
                font-size: 1.3rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .countdown-item {
                min-width: 80px;
                padding: 15px;
            }
            
            .countdown-value {
                font-size: 2rem;
            }
            
            .streak-count {
                font-size: 3rem;
            }
            
            .ai-chat-container {
                height: 400px;
            }
            
            .nav-item {
                padding: 12px 20px;
            }
        }

        @media (max-width: 576px) {
            .header {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .countdown-container {
                gap: 10px;
            }
            
            .countdown-item {
                min-width: 70px;
                padding: 10px;
            }
            
            .countdown-value {
                font-size: 1.8rem;
            }
            
            .streak-count {
                font-size: 2.5rem;
            }
            
            .message {
                max-width: 95%;
                padding: 12px;
            }
            
            .modal {
                max-width: 95%;
            }
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeInContent 0.3s ease;
        }

        @keyframes fadeInContent {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-fire"></i>
            <div>90<span>Days</span>AI</div>
        </div>
        
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="header-actions">
            <div class="user-streak">
                <i class="fas fa-fire streak-fire"></i>
                <span id="headerStreak">0</span> hari streak
            </div>
            <button class="btn btn-primary" id="startChallengeBtn">
                <i class="fas fa-play-circle"></i>
                <span>Mulai Challenge</span>
            </button>
            <button class="btn btn-secondary" id="themeToggleBtn">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="username mt-10" id="sidebarUsername">Pengguna 90 Hari</div>
                <div class="user-streak mt-10">
                    <i class="fas fa-fire streak-fire"></i>
                    <span id="sidebarStreak">0</span> hari streak
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="daily">
                    <i class="fas fa-calendar-check"></i>
                    <span>Harian</span>
                </a>
                <a href="#" class="nav-item" data-page="weekly">
                    <i class="fas fa-chart-line"></i>
                    <span>Mingguan</span>
                </a>
                <a href="#" class="nav-item" data-page="monthly">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Bulanan</span>
                </a>
                <a href="#" class="nav-item" data-page="ai">
                    <i class="fas fa-robot"></i>
                    <span>AI Companion</span>
                </a>
                <a href="#" class="nav-item" data-page="progress">
                    <i class="fas fa-chart-pie"></i>
                    <span>Progress</span>
                </a>
                <a href="#" class="nav-item" data-page="habits">
                    <i class="fas fa-tasks"></i>
                    <span>Kebiasaan</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="theme-toggle" id="sidebarThemeToggle">
                    <span>
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </span>
                    <div class="theme-switch">
                        <div class="switch" style="width: 50px; height: 26px; background-color: var(--light-color); border-radius: 13px; position: relative; cursor: pointer;">
                            <div class="switch-handle" style="width: 22px; height: 22px; background-color: var(--primary-color); border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: var(--transition);"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-20 text-center" style="font-size: 0.8rem; color: var(--gray-color);">
                    <div>90 Hari Transformasi Diri</div>
                    <div>© 2024 AI Companion</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content active">
                <h1 class="page-title">Dashboard 90 Hari</h1>
                
                <!-- Alert -->
                <div id="dashboardAlert" class="alert alert-success hidden">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Selamat!</strong> Anda telah menyelesaikan checklist harian hari ini. Pertahankan streak Anda!
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <!-- Day Counter -->
                    <div class="card hover-lift">
                        <div class="card-header">
                            <h3 class="card-title">Hari ke-</h3>
                            <div class="card-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="streak-count" id="currentDay">1</div>
                            <div class="streak-label">dari 90 Hari</div>
                            <div class="progress-container mt-20">
                                <div class="progress-label">
                                    <span>Progress Total</span>
                                    <span id="totalProgressPercent">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="totalProgressFill"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Streak Counter -->
                    <div class="card hover-lift">
                        <div class="card-header">
                            <h3 class="card-title">Streak Hari</h3>
                            <div class="card-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                        </div>
                        <div class="streak-container">
                            <div class="streak-count" id="streakCount">0
                                <div class="fire-animation">
                                    <i class="fas fa-fire"></i>
                                </div>
                            </div>
                            <div class="streak-label">Hari Berturut-turut</div>
                            <div class="streak-subtext" id="streakMessage">Mulai streak Anda hari ini!</div>
                        </div>
                    </div>
                    
                    <!-- Motivation -->
                    <div class="card hover-lift">
                        <div class="card-header">
                            <h3 class="card-title">Motivasi Hari Ini</h3>
                            <div class="card-icon">
                                <i class="fas fa-quote-left"></i>
                            </div>
                        </div>
                        <div class="text-center">
                            <div id="dailyMotivation" style="font-style: italic; font-size: 1.1rem; margin-bottom: 15px;">
                                "Konsistensi adalah kunci dari semua kesuksesan. Lakukan sedikit setiap hari."
                            </div>
                            <div style="color: var(--gray-color); font-size: 0.9rem;">
                                — AI Companion
                            </div>
                            <button class="btn btn-secondary mt-20" id="refreshMotivation">
                                <i class="fas fa-redo"></i>
                                <span>Motivasi Baru</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Countdown -->
                <div class="card mt-30 hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Countdown 90 Hari</h3>
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="countdown-container" id="countdownContainer">
                        <div class="countdown-item">
                            <div class="countdown-value" id="countdownDays">90</div>
                            <div class="countdown-label">Hari</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-value" id="countdownHours">0</div>
                            <div class="countdown-label">Jam</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-value" id="countdownMinutes">0</div>
                            <div class="countdown-label">Menit</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-value" id="countdownSeconds">0</div>
                            <div class="countdown-label">Detik</div>
                        </div>
                    </div>
                    <div class="text-center mt-20">
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Progress Challenge</span>
                                <span id="challengeProgressPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="challengeProgressFill"></div>
                            </div>
                        </div>
                        <div class="mt-10" style="color: var(--gray-color); font-size: 0.9rem;">
                            Selesai: <span id="challengeEndDate">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Today's Checklist Preview -->
                <div class="card mt-30 hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Checklist Harian Hari Ini</h3>
                        <div class="card-icon">
                            <i class="fas fa-list-check"></i>
                        </div>
                    </div>
                    <div class="checklist" id="todayChecklistPreview">
                        <!-- Checklist items will be loaded here -->
                    </div>
                    <div class="text-center mt-20">
                        <button class="btn btn-primary" id="viewDailyDetailsBtn">
                            <i class="fas fa-calendar-day"></i>
                            <span>Lihat Detail Harian</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Daily Page -->
            <div id="dailyPage" class="page-content">
                <h1 class="page-title">Checklist Harian</h1>
                
                <div class="card hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Aktivitas Harian</h3>
                        <div class="card-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                    </div>
                    
                    <div class="tab-container">
                        <div class="tab-header">
                            <button class="tab-button active" data-tab="today">Hari Ini</button>
                            <button class="tab-button" data-tab="history">Riwayat</button>
                            <button class="tab-button" data-tab="stats">Statistik</button>
                        </div>
                        
                        <div class="tab-content active" id="tabToday">
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>Checklist Harian</strong>
                                    <p>Tandai aktivitas yang sudah Anda selesaikan hari ini untuk meningkatkan streak!</p>
                                </div>
                            </div>
                            
                            <div class="checklist" id="dailyChecklist">
                                <!-- Daily checklist items will be loaded here -->
                            </div>
                            
                            <div class="text-center mt-30">
                                <button class="btn btn-success" id="saveDailyBtn">
                                    <i class="fas fa-save"></i>
                                    <span>Simpan Progress Hari Ini</span>
                                </button>
                                <button class="btn btn-secondary mt-10" id="resetDailyBtn">
                                    <i class="fas fa-redo"></i>
                                    <span>Reset Checklist</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="tabHistory">
                            <div id="dailyHistory">
                                <p class="text-center" style="color: var(--gray-color); padding: 40px;">
                                    <i class="fas fa-history fa-2x mb-10"></i><br>
                                    Riwayat harian akan ditampilkan di sini
                                </p>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="tabStats">
                            <div class="chart-container">
                                <canvas id="dailyStatsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Weekly Page -->
            <div id="weeklyPage" class="page-content">
                <h1 class="page-title">Review Mingguan</h1>
                
                <div class="card hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Evaluasi Mingguan</h3>
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-calendar-week"></i>
                        <div>
                            <strong>Minggu ke-<span id="currentWeek">1</span></strong>
                            <p>Lakukan review mingguan untuk mengevaluasi progress dan membuat rencana yang lebih baik.</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Apa yang berjalan baik minggu ini?</label>
                        <textarea class="form-textarea" id="weeklyGood" rows="3" placeholder="Tuliskan pencapaian, kebiasaan baik, atau hal positif yang terjadi minggu ini..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Apa yang bisa ditingkatkan minggu depan?</label>
                        <textarea class="form-textarea" id="weeklyImprove" rows="3" placeholder="Tuliskan area perbaikan, tantangan, atau hal yang perlu diperbaiki..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Rencana untuk minggu depan</label>
                        <textarea class="form-textarea" id="weeklyPlan" rows="3" placeholder="Tuliskan rencana, target, atau kebiasaan baru untuk minggu depan..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Evaluasi skill/iklan (jika ada)</label>
                        <textarea class="form-textarea" id="weeklySkills" rows="2" placeholder="Evaluasi perkembangan skill atau iklan yang Anda pelajari..."></textarea>
                    </div>
                    
                    <div class="text-center mt-30">
                        <button class="btn btn-success" id="saveWeeklyBtn">
                            <i class="fas fa-save"></i>
                            <span>Simpan Review Mingguan</span>
                        </button>
                        <button class="btn btn-primary mt-10" id="generateWeeklyBtn">
                            <i class="fas fa-robot"></i>
                            <span>Minta Saran AI</span>
                        </button>
                    </div>
                    
                    <div class="mt-30" id="weeklyHistory">
                        <h4 style="margin-bottom: 15px;">Riwayat Review Mingguan</h4>
                        <div id="weeklyHistoryList">
                            <p class="text-center" style="color: var(--gray-color); padding: 20px;">
                                Belum ada review mingguan
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Page -->
            <div id="monthlyPage" class="page-content">
                <h1 class="page-title">Review Bulanan</h1>
                
                <div class="card hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Evaluasi Bulanan</h3>
                        <div class="card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-chart-bar"></i>
                        <div>
                            <strong>Bulan ke-<span id="currentMonth">1</span> dari 3 Bulan</strong>
                            <p>Lakukan evaluasi bulanan untuk melihat progress secara keseluruhan dan menetapkan target baru.</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target skill baru bulan depan</label>
                        <textarea class="form-textarea" id="monthlySkillTarget" rows="2" placeholder="Skill apa yang ingin Anda pelajari atau tingkatkan bulan depan?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ide income baru</label>
                        <textarea class="form-textarea" id="monthlyIncomeIdeas" rows="2" placeholder="Ide-ide untuk menambah penghasilan atau sumber income baru"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Habit baru yang ingin dibangun</label>
                        <textarea class="form-textarea" id="monthlyNewHabits" rows="2" placeholder="Kebiasaan baru apa yang ingin Anda bangun bulan depan?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Pencapaian bulan ini</label>
                        <textarea class="form-textarea" id="monthlyAchievements" rows="3" placeholder="Apa pencapaian terbesar Anda bulan ini?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Pelajaran berharga bulan ini</label>
                        <textarea class="form-textarea" id="monthlyLessons" rows="3" placeholder="Apa pelajaran terpenting yang Anda dapatkan bulan ini?"></textarea>
                    </div>
                    
                    <div class="text-center mt-30">
                        <button class="btn btn-success" id="saveMonthlyBtn">
                            <i class="fas fa-save"></i>
                            <span>Simpan Review Bulanan</span>
                        </button>
                        <button class="btn btn-primary mt-10" id="generateMonthlyBtn">
                            <i class="fas fa-robot"></i>
                            <span>Minta Analisis AI</span>
                        </button>
                    </div>
                    
                    <div class="mt-30" id="monthlyHistory">
                        <h4 style="margin-bottom: 15px;">Riwayat Review Bulanan</h4>
                        <div id="monthlyHistoryList">
                            <p class="text-center" style="color: var(--gray-color); padding: 20px;">
                                Belum ada review bulanan
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Companion Page -->
            <div id="aiPage" class="page-content">
                <h1 class="page-title">AI Companion</h1>
                
                <div class="ai-chat-container">
                    <div class="ai-chat-header">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0;">AI Companion</h3>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Mentor & Motivator 90 Hari Anda</div>
                        </div>
                    </div>
                    
                    <div class="ai-chat-messages" id="aiChatMessages">
                        <div class="message message-ai">
                            Halo! Saya AI Companion yang akan mendampingi perjalanan 90 hari transformasi diri Anda. Saya bisa membantu sebagai mentor, motivator, problem solver, dan life coach. Apa yang bisa saya bantu hari ini?
                        </div>
                    </div>
                    
                    <div class="ai-chat-input">
                        <textarea class="chat-input" id="aiChatInput" placeholder="Tulis pesan untuk AI Companion..." rows="1"></textarea>
                        <button class="chat-send" id="aiSendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Ganti bagian button yang ada -->
<div style="display: flex; flex-direction: column; gap: 10px;">
    <button class="btn btn-warning" id="updateMemoryBtn">
        <i class="fas fa-sync"></i>
        <span>Update Memory</span>
    </button>
    <button class="btn btn-danger" id="clearMemoryBtn" onclick="clearAIMemory()">
        <i class="fas fa-trash"></i>
        <span>Clear AI Memory</span>
    </button>
</div>
                
                    
                    <div class="card hover-lift">
                        <div class="card-header">
                            <h3 class="card-title">Memory System</h3>
                            <div class="card-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                        </div>
                        <div>
                            <p style="margin-bottom: 15px;">AI Companion mengingat:</p>
                            <ul style="padding-left: 20px; margin-bottom: 20px;">
                                <li id="memoryTargets">Target: <span class="memory-placeholder">Belum diatur</span></li>
                                <li id="memoryChallenges">Tantangan: <span class="memory-placeholder">Belum diatur</span></li>
                                <li id="memoryProgress">Progress: <span class="memory-placeholder">Belum ada</span></li>
                                <li id="memoryAchievements">Pencapaian: <span class="memory-placeholder">Belum ada</span></li>
                            </ul>
                            <button class="btn btn-warning w-100" id="updateMemoryBtn">
                                <i class="fas fa-sync"></i>
                                <span>Update Memory</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Page -->
            <div id="progressPage" class="page-content">
                <h1 class="page-title">Progress 90 Hari</h1>
                
                <div class="card hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Statistik Progress</h3>
                        <div class="card-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <h4 class="card-title mb-20">Statistik Harian</h4>
                            <div class="chart-container">
                                <canvas id="dailyCompletionChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h4 class="card-title mb-20">Progress per Kategori</h4>
                            <div class="chart-container">
                                <canvas id="categoryProgressChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-30">
                        <h4 class="card-title mb-20">Ringkasan Progress</h4>
                        <div class="dashboard-grid">
                            <div class="card text-center">
                                <div class="streak-count" id="progressTotalDays">0</div>
                                <div class="streak-label">Total Hari</div>
                            </div>
                            
                            <div class="card text-center">
                                <div class="streak-count" style="color: var(--success-color);" id="progressCompletedDays">0</div>
                                <div class="streak-label">Hari Terselesaikan</div>
                            </div>
                            
                            <div class="card text-center">
                                <div class="streak-count" style="color: var(--primary-color);" id="progressCompletionRate">0%</div>
                                <div class="streak-label">Tingkat Penyelesaian</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-30">
                        <h4 class="card-title mb-20">Pencapaian</h4>
                        <div id="achievementsList">
                            <div class="alert alert-success">
                                <i class="fas fa-trophy"></i>
                                <div>
                                    <strong>Pertama Kali!</strong>
                                    <p>Anda telah memulai perjalanan 90 hari transformasi diri</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Habits Page -->
            <div id="habitsPage" class="page-content">
                <h1 class="page-title">Sistem Kebiasaan</h1>
                
                <div class="card hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Bangun Kebiasaan Baik</h3>
                        <div class="card-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-fire"></i>
                        <div>
                            <strong>Streak Challenge</strong>
                            <p>Pertahankan streak Anda! Setiap 7 hari streak berturut-turut, Anda akan mendapatkan reward khusus.</p>
                        </div>
                    </div>
                    
                    <div class="mt-20">
                        <h4 style="margin-bottom: 15px;">Kebiasaan Inti 90 Hari</h4>
                        <div class="checklist" id="coreHabitsList">
                            <!-- Core habits will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="mt-30">
                        <h4 style="margin-bottom: 15px;">Tambah Kebiasaan Baru</h4>
                        <div class="form-group">
                            <input type="text" class="form-input" id="newHabitName" placeholder="Nama kebiasaan baru">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="newHabitDescription" rows="2" placeholder="Deskripsi kebiasaan"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategori</label>
                            <select class="form-input" id="newHabitCategory">
                                <option value="discipline">Disiplin</option>
                                <option value="skill">Skill Development</option>
                                <option value="health">Kesehatan</option>
                                <option value="mental">Mental Growth</option>
                                <option value="spiritual">Spiritual Growth</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="addHabitBtn">
                            <i class="fas fa-plus"></i>
                            <span>Tambah Kebiasaan</span>
                        </button>
                    </div>
                    
                    <div class="mt-30">
                        <h4 style="margin-bottom: 15px;">Kebiasaan Saya</h4>
                        <div id="userHabitsList">
                            <p class="text-center" style="color: var(--gray-color); padding: 20px;">
                                Belum ada kebiasaan yang ditambahkan
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="settingsPage" class="page-content">
                <h1 class="page-title">Pengaturan</h1>
                
                <div class="card hover-lift">
                    <div class="card-header">
                        <h3 class="card-title">Pengaturan Aplikasi</h3>
                        <div class="card-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nama Pengguna</label>
                        <input type="text" class="form-input" id="settingsUsername" value="Pengguna 90 Hari">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target 90 Hari</label>
                        <textarea class="form-textarea" id="settingsTarget" rows="3" placeholder="Apa target utama Anda dalam 90 hari ke depan?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Area Perbaikan</label>
                        <textarea class="form-textarea" id="settingsImprovement" rows="3" placeholder="Area apa yang paling ingin Anda perbaiki?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notifikasi</label>
                        <div class="d-flex flex-column gap-10 mt-10">
                            <label class="d-flex align-center" style="cursor: pointer;">
                                <input type="checkbox" id="settingsNotifications" checked style="margin-right: 10px;">
                                <span>Aktifkan notifikasi harian</span>
                            </label>
                            <label class="d-flex align-center" style="cursor: pointer;">
                                <input type="checkbox" id="settingsReminders" checked style="margin-right: 10px;">
                                <span>Ingatkan checklist harian</span>
                            </label>
                            <label class="d-flex align-center" style="cursor: pointer;">
                                <input type="checkbox" id="settingsWeeklyReview" checked style="margin-right: 10px;">
                                <span>Notifikasi review mingguan</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="text-center mt-30">
                        <button class="btn btn-success" id="saveSettingsBtn">
                            <i class="fas fa-save"></i>
                            <span>Simpan Pengaturan</span>
                        </button>
                        <button class="btn btn-secondary mt-10" id="exportDataBtn">
                            <i class="fas fa-download"></i>
                            <span>Ekspor Data</span>
                        </button>
                        <button class="btn btn-danger mt-10" id="resetDataBtn">
                            <i class="fas fa-trash"></i>
                            <span>Reset Data</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="startChallengeModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Mulai Challenge 90 Hari</h3>
                <button class="modal-close" id="closeChallengeModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Anda akan memulai perjalanan transformasi diri selama 90 hari. Challenge akan dimulai hari ini dan berlangsung selama 90 hari ke depan.</p>
                <div class="form-group mt-20">
                    <label class="form-label">Target utama Anda dalam 90 hari</label>
                    <textarea class="form-textarea" id="challengeTarget" rows="3" placeholder="Contoh: Meningkatkan disiplin, belajar skill baru, meningkatkan income, dll."></textarea>
                </div>
                <div class="form-group mt-20">
                    <label class="form-label">Mengapa ini penting untuk Anda?</label>
                    <textarea class="form-textarea" id="challengeWhy" rows="2" placeholder="Alasan dan motivasi Anda"></textarea>
                </div>
                <div class="text-center mt-30">
                    <button class="btn btn-primary w-100" id="confirmStartChallenge">
                        <i class="fas fa-play-circle"></i>
                        <span>Mulai Sekarang!</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="modal-overlay hidden">
    <div class="modal" style="background: transparent; box-shadow: none; max-width: 200px;">
        <div class="modal-body text-center">
            <div class="loading">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
            <div style="color: white; margin-top: 20px; font-weight: 600;">AI sedang mengetik...</div>
        </div>
    </div>
</div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // ============================================
        // VARIABLES GLOBAL
        // ============================================
        let currentUser = null;
        let currentChallenge = null;
        let dailyChecklists = [];
        let weeklyReviews = [];
        let monthlyReviews = [];
        let aiMemory = [];
        let conversationHistory = [];
        let userHabits = [];
        let aiConversation = [];
        let charts = {};
        let countdownInterval = null;
        
        // ============================================
// DAFTAR API ENDPOINTS UNTUK ROTASI
// ============================================
const API_ENDPOINTS = [
    'https://fazmen-ai.fakyew542.workers.dev/?prompt={prompt}&userid={userid}',
    'https://fazmen-ai.anonymoustim85.workers.dev/?prompt={prompt}&userid={userid}'
];

let currentAPIIndex = 0; // Track API mana yang sedang dipakai


// ============================================
// SMART RESPONSE VALIDATOR & COMPLETER
// ============================================
class ResponseValidator {
    static isResponseComplete(response) {
        if (!response || response.trim().length < 10) return false;
        
        const text = response.trim();
        
        // Cek jika response memiliki tanda selesai
        const completionMarkers = [
            '### END OF RESPONSE ###',
            '[RESPONSE COMPLETE]',
            '**Selesai**',
            'Semoga membantu',
            'Terima kasih',
            '--- END ---',
            '\n\n\n', // Multiple newlines di akhir
            '.', // Berakhir dengan titik (kalimat lengkap)
            '?', // Berakhir dengan tanda tanya
            '!'  // Berakhir dengan tanda seru
        ];
        
        // Cek jika berakhir dengan tanda baca yang wajar
        const lastChar = text.charAt(text.length - 1);
        const endsWithProperPunctuation = ['.', '?', '!', ':', ')', ']', '}'].includes(lastChar);
        
        // Cek panjang minimum untuk response yang wajar
        const hasMinimumLength = text.length > 100;
        
        // Cek struktur - apakah ada poin-poin atau paragraf
        const hasStructure = (text.includes('\n') || text.includes('-') || text.includes('•') || 
                             text.includes('1.') || text.includes('*'));
        
        return endsWithProperPunctuation && hasMinimumLength && hasStructure;
    }
    
    static estimateMissingContent(response) {
        // Analisis untuk estimasi konten yang hilang
        const text = response.toLowerCase();
        
        // Cek tanda-tanda response terpotong
        const truncationIndicators = [
            response.endsWith('...'),
            response.endsWith('--'),
            response.endsWith('..'),
            text.includes('selanjutnya') && !text.includes('selanjutnya)'),
            text.includes('lanjut') && !text.endsWith('.'),
            (text.match(/\d+\./g) || []).length > 0 && !text.includes('kesimpulan'),
            text.includes('poin') && !text.includes('terakhir')
        ];
        
        return truncationIndicators.some(indicator => indicator);
    }
}

// ============================================
// RESPONSE COMPLETION SYSTEM
// ============================================
async function getCompleteResponse(prompt, isLongResponse = false, maxRetries = 2) {
    console.log('Getting complete response for:', prompt.substring(0, 100) + '...');
    
    // Pilih API endpoint berdasarkan tipe response
    const endpointType = isLongResponse ? 'long' : 'regular';
    const suitableEndpoints = API_ENDPOINTS.filter(ep => ep.type === endpointType);
    
    if (suitableEndpoints.length === 0) {
        console.warn('No suitable endpoints found, using all');
        suitableEndpoints.push(...API_ENDPOINTS);
    }
    
    let bestResponse = '';
    let attempts = 0;
    
    for (const endpoint of suitableEndpoints) {
        if (attempts >= maxRetries) break;
        
        try {
            console.log(`Attempt ${attempts + 1} with endpoint: ${endpoint.url.split('/')[2]}`);
            
            const optimizedPrompt = createOptimizedPrompt(prompt);
            const apiUrl = endpoint.url
                .replace('{prompt}', encodeURIComponent(optimizedPrompt))
                .replace('{userid}', encodeURIComponent(systemState.userId));
            
            const response = await fetchWithTimeout(apiUrl, {
                timeout: isLongResponse ? 45000 : 25000 // 45 detik untuk long responses
            });
            
            if (response.ok) {
                let responseText = await response.text();
                
                // Validasi response
                if (ResponseValidator.isResponseComplete(responseText)) {
                    console.log('✅ Response complete and valid');
                    return cleanResponse(responseText);
                } else if (ResponseValidator.estimateMissingContent(responseText)) {
                    console.log('⚠️ Response might be truncated, trying to complete...');
                    
                    // Coba lanjutkan response yang terpotong
                    const continuationPrompt = `Lanjutkan response ini dari bagian terakhir:\n\n"${responseText.substring(responseText.length - 500)}"\n\nLanjutkan dengan bagian berikutnya dan pastikan menyelesaikan semua poin.`;
                    const continuation = await getContinuationResponse(continuationPrompt);
                    
                    if (continuation) {
                        responseText += '\n\n' + continuation;
                        if (ResponseValidator.isResponseComplete(responseText)) {
                            return cleanResponse(responseText);
                        }
                    }
                }
                
                // Simpan sebagai best response jika lebih baik dari sebelumnya
                if (responseText.length > bestResponse.length) {
                    bestResponse = responseText;
                }
            }
            
            attempts++;
            
        } catch (error) {
            console.error(`Attempt ${attempts + 1} failed:`, error.message);
            attempts++;
        }
    }
    
    // Jika masih dapat response walau tidak sempurna
    if (bestResponse.length > 50) {
        console.log('Using best available response');
        return cleanResponse(bestResponse);
    }
    
    throw new Error('Unable to get complete response from any endpoint');
}

// ============================================
// FETCH WITH TIMEOUT & RETRY
// ============================================
async function fetchWithTimeout(url, options = {}) {
    const { timeout = 30000, ...fetchOptions } = options;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(url, {
            ...fetchOptions,
            signal: controller.signal,
            headers: {
                'Accept': 'text/plain, */*',
                'Content-Type': 'text/plain',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept-Language': 'id-ID,id;q=0.9,en;q=0.8'
            }
        });
        
        clearTimeout(timeoutId);
        return response;
        
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

// ============================================
// CONTINUATION SYSTEM UNTUK LONG RESPONSES
// ============================================
async function getContinuationResponse(partialResponse) {
    const continuationPrompt = `Response sebelumnya terpotong. Lanjutkan tepat dari sini dan selesaikan penjelasannya:\n\n"${partialResponse}"\n\nLanjutkan dengan bagian berikutnya dan berikan penutup yang baik.`;
    
    try {
        const continuation = await makeAIRequest(continuationPrompt, false);
        
        // Validasi continuation tidak kosong
        if (continuation && continuation.length > 20) {
            return continuation;
        }
    } catch (error) {
        console.error('Continuation failed:', error);
    }
    
    return null;
}

// ============================================
// ENHANCED RESPONSE CLEANING (MINIMAL)
// ============================================
function cleanResponse(text) {
    if (!text) return '';
    
    let cleaned = text.trim();
    
    // Hanya lakukan cleaning yang benar-benar diperlukan
    // 1. Normalize whitespace (tapi jangan berlebihan)
    cleaned = cleaned.replace(/\r\n/g, '\n');
    cleaned = cleaned.replace(/\r/g, '\n');
    cleaned = cleaned.replace(/\n{3,}/g, '\n\n'); // Max 2 newlines
    
    // 2. Hapus completion markers yang kita tambahkan
    cleaned = cleaned.replace(/\[RESPONSE COMPLETE\]/g, '');
    cleaned = cleaned.replace(/### END OF RESPONSE ###/g, '');
    cleaned = cleaned.replace(/\[INSTRUCTION:.*?\]/g, '');
    cleaned = cleaned.replace(/\[FORMAT:.*?\]/g, '');
    cleaned = cleaned.replace(/\[REQUIREMENT:.*?\]/g, '');
    cleaned = cleaned.replace(/\[END MARKER:.*?\]/g, '');
    cleaned = cleaned.replace(/\[MOHON.*?\]/g, '');
    cleaned = cleaned.replace(/\[JIKA.*?\]/g, '');
    cleaned = cleaned.replace(/\[PASTIKAN.*?\]/g, '');
    cleaned = cleaned.replace(/\[AKHIRI.*?\]/g, '');
    
    // 3. Hapus markdown hanya jika mengganggu, jangan semua
    // Biarkan ** untuk emphasis, hanya hapus jika double di awal/akhir
    cleaned = cleaned.replace(/^\*\*|\*\*$/g, '');
    
    // 4. Trim lagi setelah cleaning
    cleaned = cleaned.trim();
    
    // 5. Pastikan response tidak kosong
    if (cleaned.length === 0) {
        return text.substring(0, Math.min(text.length, 500)); // Return original jika cleaning menghapus semua
    }
    
    return cleaned;
}

// ============================================
// ENHANCED AI REQUEST FUNCTION (REPLACE YANG LAMA)
// ============================================
async function makeAIRequest(prompt, isLongResponse = false) {
    console.log('Making AI request (enhanced)...');
    
    // Gunakan response completion system
    try {
        const response = await getCompleteResponse(prompt, isLongResponse);
        
        // Log untuk debugging
        console.log('✅ Response length:', response.length);
        console.log('✅ First 200 chars:', response.substring(0, 200));
        console.log('✅ Last 200 chars:', response.substring(response.length - 200));
        
        return response;
        
    } catch (error) {
        console.error('Enhanced AI request failed:', error);
        
        // Fallback ke method lama
        return await makeAIFallbackRequest(prompt);
    }
}

// ============================================
// FALLBACK SYSTEM (JIKA SEMUA GAGAL)
// ============================================
async function makeAIFallbackRequest(prompt) {
    console.log('Using fallback request system...');
    
    // Coba semua endpoints secara bergantian
    for (const endpoint of API_ENDPOINTS) {
        try {
            const apiUrl = endpoint.url
                .replace('{prompt}', encodeURIComponent(prompt))
                .replace('{userid}', encodeURIComponent(systemState.userId));
            
            const response = await fetch(apiUrl, { 
                method: 'GET',
                headers: {
                    'Accept': 'text/plain',
                    'Content-Type': 'text/plain'
                }
            });
            
            if (response.ok) {
                const text = await response.text();
                if (text && text.trim().length > 10) {
                    return text.trim();
                }
            }
        } catch (error) {
            continue; // Coba endpoint berikutnya
        }
    }
    
    // Jika semua gagal, gunakan enhanced fallback
    return getEnhancedFallbackResponse(prompt);
}

// ============================================
// USER AGENTS UNTUK KEAMANAN
// ============================================
const USER_AGENTS = [
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
];

const ACCEPT_LANGUAGES = [
    'en-US,en;q=0.9',
    'id-ID,id;q=0.9,en;q=0.8',
    'de-DE,de;q=0.9,en;q=0.8',
    'fr-FR,fr;q=0.9,en;q=0.8',
    'es-ES,es;q=0.9,en;q=0.8'
];

// ============================================
// SISTEM STATE MANAGEMENT
// ============================================
class SystemState {
    constructor() {
        this.monitoring = {};
        this.apiHealth = {};
        this.userId = this.generateUserId();
        this.currentApiIndex = 0;
        this.retryCount = 0;
    }

    generateUserId() {
        const randomId = Math.random().toString(36).substring(2) + 
                       Date.now().toString(36) + 
                       Math.random().toString(36).substring(2);
        return 'user_' + randomId.substring(0, 16);
    }

    initializeAPIHealth() {
        const healthData = {};
        API_ENDPOINTS.forEach((endpoint, index) => {
            healthData[index] = {
                url: endpoint,
                successCount: 0,
                failureCount: 0,
                lastSuccess: null,
                lastFailure: null,
                averageResponseTime: 0,
                healthScore: 100,
                isBlocked: false
            };
        });
        this.apiHealth = healthData;
    }
}

const systemState = new SystemState();

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const startChallengeBtn = document.getElementById('startChallengeBtn');
        const startChallengeModal = document.getElementById('startChallengeModal');
        const closeChallengeModal = document.getElementById('closeChallengeModal');
        const confirmStartChallenge = document.getElementById('confirmStartChallenge');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const refreshMotivationBtn = document.getElementById('refreshMotivation');

        // Pages
        const pages = {
            dashboard: document.getElementById('dashboardPage'),
            daily: document.getElementById('dailyPage'),
            weekly: document.getElementById('weeklyPage'),
            monthly: document.getElementById('monthlyPage'),
            ai: document.getElementById('aiPage'),
            progress: document.getElementById('progressPage'),
            habits: document.getElementById('habitsPage'),
            settings: document.getElementById('settingsPage')
        };

        // Navigation
        const navItems = document.querySelectorAll('.nav-item');
        
        // ============================================
// FUNGSI KEAMANAN
// ============================================
function getRandomUserAgent() {
    const randomIndex = Math.floor(Math.random() * USER_AGENTS.length);
    return USER_AGENTS[randomIndex];
}

function createEnhancedHeaders() {
    const userAgent = getRandomUserAgent();
    const acceptLanguage = ACCEPT_LANGUAGES[Math.floor(Math.random() * ACCEPT_LANGUAGES.length)];
    
    return {
        'User-Agent': userAgent,
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/avif,*/*;q=0.8',
        'Accept-Language': acceptLanguage,
        'Accept-Encoding': 'gzip, deflate, br',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        'Sec-Fetch-Dest': 'document',
        'Sec-Fetch-Mode': 'navigate',
        'Sec-Fetch-Site': 'cross-site',
        'Pragma': 'no-cache',
        'Upgrade-Insecure-Requests': '1'
    };
}

// ============================================
// SISTEM ROTASI API
// ============================================
function getBestAPIEndpoint() {
    if (!systemState.apiHealth || Object.keys(systemState.apiHealth).length === 0) {
        systemState.initializeAPIHealth();
    }
    
    const now = new Date();
    const availableAPIs = [];
    
    for (let i = 0; i < API_ENDPOINTS.length; i++) {
        const health = systemState.apiHealth[i];
        if (!health) continue;
        
        if (health.isBlocked) continue;
        
        availableAPIs.push({
            index: i,
            healthScore: health.healthScore,
            avgResponseTime: health.averageResponseTime || 1000
        });
    }
    
    if (availableAPIs.length === 0) {
        return Math.floor(Math.random() * API_ENDPOINTS.length);
    }
    
    availableAPIs.sort((a, b) => {
        if (b.healthScore !== a.healthScore) return b.healthScore - a.healthScore;
        return a.avgResponseTime - b.avgResponseTime;
    });
    
    const topCandidates = availableAPIs.slice(0, 3);
    return topCandidates[Math.floor(Math.random() * topCandidates.length)].index;
}

function updateAPIHealth(apiIndex, success, responseTime = null) {
    if (!systemState.apiHealth[apiIndex]) {
        systemState.initializeAPIHealth();
    }
    
    const health = systemState.apiHealth[apiIndex];
    
    if (success) {
        health.successCount++;
        health.lastSuccess = new Date().toISOString();
        if (responseTime) {
            health.averageResponseTime = health.averageResponseTime 
                ? (health.averageResponseTime * 0.7 + responseTime * 0.3)
                : responseTime;
        }
        health.healthScore = Math.min(100, health.healthScore + 5);
        
        if (health.isBlocked) {
            health.isBlocked = false;
        }
    } else {
        health.failureCount++;
        health.lastFailure = new Date().toISOString();
        health.healthScore = Math.max(0, health.healthScore - 15);
    }
    
    systemState.apiHealth[apiIndex] = health;
    localStorage.setItem('api_health', JSON.stringify(systemState.apiHealth));
}
// ============================================
// ENHANCED AI REQUEST FUNCTION
// ============================================
async function makeAIRequest(prompt, isLongResponse = false) {
    console.log('Making AI request...');
    
    // Enhanced prompt untuk response lengkap
    const enhancedPrompt = isLongResponse 
        ? `${prompt}\n\nTOLONG BERIKAN RESPONSE YANG LENGKAP DAN UTUH. JANGAN POTONG DI TENGAH KALIMAT. JIKA RESPONSE PANJANG, GUNAKAN FORMAT YANG RAPI DENGAN PARAGRAF YANG JELAS.`
        : prompt;
    
    const userId = systemState.userId || 'user_123';
    
    // PERBAIKAN: Loop semua API endpoints sebagai fallback
    for (let i = 0; i < API_ENDPOINTS.length; i++) {
        // Mulai dari API terakhir yang berhasil, lalu coba yang lain
        const apiIndex = (currentAPIIndex + i) % API_ENDPOINTS.length;
        const apiTemplate = API_ENDPOINTS[apiIndex];
        
        // Replace placeholder dengan data sebenarnya
        const apiUrl = apiTemplate
            .replace('{prompt}', encodeURIComponent(enhancedPrompt))
            .replace('{userid}', encodeURIComponent(userId));
        
        console.log(`Trying API ${apiIndex + 1}/${API_ENDPOINTS.length}: ${apiTemplate.split('?')[0]}`);
        
        try {
            // Timeout diperpanjang untuk response panjang
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), isLongResponse ? 60000 : 30000);
            
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/plain',
                    'Content-Type': 'text/plain'
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                let reply = await response.text();
                
                // Validasi response utuh
                if (!reply || reply.trim().length === 0) {
                    throw new Error('Empty response from AI');
                }
                
                const trimmedReply = reply.trim();
                console.log(`✅ API ${apiIndex + 1} SUCCESS - Response length:`, trimmedReply.length);
                
                // Update currentAPIIndex ke API yang berhasil
                currentAPIIndex = apiIndex;
                
                // Bersihkan response dengan lebih hati-hati
                reply = trimmedReply;
                
                // Hapus markdown HANYA yang mengganggu
                reply = reply.replace(/\*\*(.+?)\*\*/g, '$1') // Ganti **text** jadi text
                            .replace(/\*(.+?)\*/g, '$1')     // Ganti *text* jadi text
                            .replace(/#{1,6}\s?/g, '')       // Hapus ###
                            .replace(/\n{3,}/g, '\n\n')      // Max 2 newline berturut
                            .replace(/\\n/g, '\n')
                            .replace(/\\"/g, '"')
                            .replace(/\\r/g, '')
                            .trim();
                
                // Hilangkan tanda kutip di awal dan akhir saja
                if (reply.startsWith('"') && reply.endsWith('"')) {
                    reply = reply.slice(1, -1);
                }
                
                // Normalize whitespace lebih baik
                reply = reply.replace(/[ \t]+/g, ' ')         // Hanya normalize spasi dan tab horizontal
                            .replace(/\s+\./g, '.')          // Hapus spasi sebelum titik
                            .replace(/\s+,/g, ',')           // Hapus spasi sebelum koma
                            .replace(/([.,!?])([A-Za-z])/g, '$1 $2'); // Pastikan spasi setelah tanda baca
                
                console.log('Cleaned response length:', reply.length);
                console.log('First 100 chars:', reply.substring(0, 100));
                console.log('Last 100 chars:', reply.substring(reply.length - 100));
                
                return reply;
                
            } else {
                throw new Error(`API ${apiIndex + 1} Error: ${response.status} - ${response.statusText}`);
            }
            
        } catch (error) {
            console.error(`❌ API ${apiIndex + 1} FAILED:`, error.message);
            
            // Jika ini bukan API terakhir, lanjut ke API berikutnya
            if (i < API_ENDPOINTS.length - 1) {
                console.log(`⏭️ Trying next API...`);
                continue; // Coba API berikutnya
            } else {
                // Semua API sudah dicoba dan gagal
                console.error('❌ ALL APIs FAILED');
                
                // Retry logic untuk timeout - coba sekali lagi dari awal
                if (error.name === 'AbortError' && systemState.retryCount < 1) {
                    console.log('🔄 Request timeout, retrying all APIs...');
                    systemState.retryCount++;
                    return makeAIRequest(prompt, isLongResponse);
                }
                
                systemState.retryCount = 0;
                throw new Error('Semua API endpoint gagal. Silakan coba lagi.');
            }
        }
    }
}


// ============================================
// TAMBAHAN: Function untuk cek health semua API (OPTIONAL)
// ============================================

async function checkAPIHealth() {
    console.log('Checking API health...');
    const healthStatus = [];
    
    for (let i = 0; i < API_ENDPOINTS.length; i++) {
        const apiTemplate = API_ENDPOINTS[i];
        const testUrl = apiTemplate
            .replace('{prompt}', encodeURIComponent('test'))
            .replace('{userid}', encodeURIComponent('health_check'));
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 detik timeout
            
            const response = await fetch(testUrl, { 
                method: 'GET',
                signal: controller.signal 
            });
            
            clearTimeout(timeoutId);
            
            healthStatus.push({
                index: i,
                endpoint: apiTemplate.split('?')[0],
                status: response.ok ? 'online' : 'error',
                responseTime: response.ok ? 'OK' : response.status
            });
            
            console.log(`API ${i + 1}: ${response.ok ? '✅ Online' : '❌ Offline'}`);
            
        } catch (error) {
            healthStatus.push({
                index: i,
                endpoint: apiTemplate.split('?')[0],
                status: 'offline',
                error: error.message
            });
            console.log(`API ${i + 1}: ❌ Offline (${error.message})`);
        }
    }
    
    return healthStatus;
}

// ============================================
// ENHANCED FALLBACK RESPONSE
// ============================================
function getEnhancedFallbackResponse(prompt) {
    const lowerPrompt = prompt.toLowerCase();
    
    if (lowerPrompt.includes('hai') || lowerPrompt.includes('halo') || lowerPrompt.includes('hello')) {
        return "Halo! Saya AI Companion siap membantu perjalanan 90 hari transformasi diri Anda.\n\nSaya akan membantu sebagai mentor, motivator, dan problem solver. Apa yang bisa saya bantu hari ini?\n\nSilakan ceritakan target utama Anda atau tantangan yang sedang dihadapi.";
    }
    
    if (lowerPrompt.includes('motivasi') || lowerPrompt.includes('semangat')) {
        return "🔥 MOTIVASI HARI INI 🔥\n\nIngatlah bahwa konsistensi adalah kunci utama kesuksesan! Setiap langkah kecil yang Anda lakukan hari ini membawa Anda lebih dekat ke tujuan besar.\n\n• Progress lebih penting daripada kesempurnaan\n• Konsistensi mengalahkan intensitas sesaat\n• Aksi nyata lebih berharga daripada wacana\n\nTetap semangat dan lanjutkan perjalanan Anda! Setiap hari adalah kesempatan baru untuk berkembang. 💪";
    }
    
    if (lowerPrompt.includes('progress') || lowerPrompt.includes('kemajuan')) {
        return "📊 ANALISIS PROGRESS\n\nProgress Anda sangat berarti. Fokus pada proses dan nikmati perjalanan transformasi diri ini.\n\nTips untuk meningkatkan progress:\n1. Review checklist harian secara konsisten\n2. Rayakan kemenangan kecil setiap hari\n3. Pelajari dari tantangan yang dihadapi\n4. Adjust rencana sesuai kebutuhan\n\nIngat: Transformasi adalah marathon, bukan sprint.";
    }
    
    return "Terima kasih atas pesan Anda! 🙏\n\nSaya siap membantu perjalanan transformasi 90 hari Anda. Untuk respons yang lebih akurat, bisa Anda jelaskan:\n\n1. Apa target spesifik Anda dalam 90 hari ini?\n2. Tantangan apa yang sedang Anda hadapi?\n3. Bagaimana progress harian Anda sejauh ini?\n4. Area apa yang paling ingin Anda tingkatkan?\n\nDengan informasi ini, saya bisa memberikan bantuan yang lebih personal dan tepat!";
}

function getFallbackResponse(prompt) {
    const lowerPrompt = prompt.toLowerCase();
    
    if (lowerPrompt.includes('hai') || lowerPrompt.includes('halo') || lowerPrompt.includes('hello')) {
        return "Halo! Saya AI Companion siap membantu perjalanan 90 hari transformasi diri Anda. Apa yang bisa saya bantu hari ini?";
    }
    
    if (lowerPrompt.includes('motivasi') || lowerPrompt.includes('semangat')) {
        const motivations = [
            "Konsistensi adalah kunci kesuksesan. Setiap hari adalah kesempatan baru untuk berkembang!",
            "Progress Anda sangat berarti. Fokus pada proses dan nikmati perjalanan transformasi diri ini.",
            "Ingatlah bahwa perubahan kecil yang konsisten menghasilkan hasil yang besar. Tetap semangat!",
            "Hari ini adalah kesempatan untuk menjadi versi terbaik dari dirimu. Lakukan yang terbaik!",
            "Disiplin adalah jembatan antara tujuan dan pencapaian. Pertahankan konsistensimu!"
        ];
        return motivations[Math.floor(Math.random() * motivations.length)];
    }
    
    return "Terima kasih atas pesan Anda. Saat ini saya siap membantu perjalanan transformasi 90 hari Anda. Ada yang bisa saya bantu lebih spesifik?";
}

// ============================================
// FUNGSI FALLBACK SEDERHANA
// ============================================
function generateSimpleFallback(prompt) {
    const lowerPrompt = prompt.toLowerCase();
    
    if (lowerPrompt.includes('hai') || lowerPrompt.includes('halo') || lowerPrompt.includes('hello')) {
        return "Halo! Saya AI Companion siap membantu perjalanan 90 hari transformasi diri Anda. Apa yang bisa saya bantu hari ini?";
    }
    
    if (lowerPrompt.includes('motivasi') || lowerPrompt.includes('semangat')) {
        return "Ingatlah bahwa konsistensi adalah kunci kesuksesan. Setiap hari adalah kesempatan baru untuk berkembang. Tetap semangat!";
    }
    
    if (lowerPrompt.includes('progress') || lowerPrompt.includes('kemajuan')) {
        return "Progress Anda sangat berarti. Fokus pada proses dan nikmati perjalanan transformasi diri ini.";
    }
    
    return "Terima kasih atas pesan Anda. Saat ini sistem sedang optimal. Silakan lanjutkan dengan pertanyaan atau masalah spesifik yang ingin dibahas.";
}

// ============================================
// FUNGSI TAMPILAN AI RESPONSE DENGAN EFEK TYPING
// ============================================
function showAIResponseWithTypingEffect(message, onComplete = null) {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    // Hapus typing indicator jika ada
    removeTypingIndicator();
    
    // Buat elemen pesan
    const messageElement = document.createElement('div');
    messageElement.className = 'message message-ai';
    messageElement.style.opacity = '0';
    messageElement.style.maxHeight = '0';
    messageElement.style.overflow = 'hidden';
    
    container.appendChild(messageElement);
    
    // Simulasi typing effect
    let index = 0;
    const typingSpeed = 20; // ms per karakter
    
    function typeCharacter() {
        if (index < message.length) {
            messageElement.textContent = message.substring(0, index + 1);
            index++;
            
            // Animasi muncul
            if (index === 1) {
                messageElement.style.transition = 'opacity 0.3s ease, max-height 0.5s ease';
                messageElement.style.opacity = '1';
                messageElement.style.maxHeight = '500px';
            }
            
            setTimeout(typeCharacter, typingSpeed);
            
            // Auto-scroll
            container.scrollTop = container.scrollHeight;
            
        } else {
            // Selesai
            messageElement.style.transition = 'none';
            
            if (onComplete) {
                setTimeout(onComplete, 100);
            }
            
            // Simpan ke conversation
            try {
                const currentConvo = JSON.parse(localStorage.getItem('ai_conversation') || '[]');
                currentConvo.push({ role: 'assistant', content: message });
                localStorage.setItem('ai_conversation', JSON.stringify(currentConvo));
            } catch (e) {
                console.warn('Failed to save to conversation:', e);
            }
        }
    }
    
    // Mulai typing setelah delay kecil
    setTimeout(() => {
        typeCharacter();
    }, 300);
}

// ============================================
// FUNGSI TYPING INDICATOR
// ============================================
function showTypingIndicator() {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    // Hapus yang lama
    removeTypingIndicator();
    
    // Buat baru
    const indicator = document.createElement('div');
    indicator.className = 'ai-typing';
    indicator.id = 'aiTypingIndicator';
    indicator.innerHTML = `
        <div class="ai-typing-text">AI sedang mengetik</div>
        <div class="ai-typing-dots">
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
        </div>
    `;
    
    container.appendChild(indicator);
    container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('aiTypingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

function addAIMessage(message, role) {
    const container = document.getElementById('aiChatMessages');
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${role === 'user' ? 'message-user' : 'message-ai'}`;
    
    if (role === 'ai') {
        // Format AI response dengan markdown
        const formattedMessage = formatAIResponse(message);
        messageElement.innerHTML = `
            <div class="message-content">${formattedMessage}</div>
            <div class="message-actions ${role === 'ai' ? 'visible' : ''}">
                <button class="copy-btn" title="Salin pesan">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="regenerate-btn" title="Regenerasi response">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        `;
        
        // Tambahkan event listener untuk tombol copy
        const copyBtn = messageElement.querySelector('.copy-btn');
        copyBtn.addEventListener('click', () => {
            copyToClipboard(message);
        });
        
        // Tombol regenerate
        const regenerateBtn = messageElement.querySelector('.regenerate-btn');
        regenerateBtn.addEventListener('click', () => {
            if (role === 'ai') {
                regenerateAIResponse(messageElement);
            }
        });
        
    } else {
        // User message biasa
        messageElement.textContent = message;
    }
    
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
}

// Fungsi copy ke clipboard
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        showNotification('Pesan disalin ke clipboard!', 'success');
        
        // Visual feedback
        const event = new CustomEvent('copySuccess');
        document.dispatchEvent(event);
        
    } catch (err) {
        console.error('Gagal menyalin:', err);
        // Fallback method
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Pesan disalin!', 'success');
    }
}

// Fungsi regenerasi response
async function regenerateAIResponse(messageElement) {
    const lastUserMessage = getLastUserMessage();
    if (!lastUserMessage) return;
    
    // Tampilkan loading
    const originalContent = messageElement.innerHTML;
    messageElement.innerHTML = '<div class="message-content"><i>Regenerasi response...</i></div>';
    
    try {
        const hasMemory = systemState.memory[systemState.userId] && systemState.memory[systemState.userId].length > 0;
        const newResponse = await makeAIRequest(lastUserMessage, hasMemory);
        
        // Format new response
        const formattedResponse = formatAIResponse(newResponse);
        messageElement.innerHTML = `
            <div class="message-content">${formattedResponse}</div>
            <div class="message-actions visible">
                <button class="copy-btn" title="Salin pesan">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="regenerate-btn" title="Regenerasi response">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        `;
        
        // Re-attach event listeners
        const copyBtn = messageElement.querySelector('.copy-btn');
        copyBtn.addEventListener('click', () => copyToClipboard(newResponse));
        
        const regenerateBtn = messageElement.querySelector('.regenerate-btn');
        regenerateBtn.addEventListener('click', () => regenerateAIResponse(messageElement));
        
        showNotification('Response diregenerasi!', 'success');
        
    } catch (error) {
        console.error('Regenerasi gagal:', error);
        messageElement.innerHTML = originalContent;
        showNotification('Gagal meregenerasi response', 'error');
    }
}

function getLastUserMessage() {
    const messages = document.querySelectorAll('.message-user');
    if (messages.length > 0) {
        return messages[messages.length - 1].textContent;
    }
    return null;
}

function copyAIMessage(buttonElement, encodedMessage) {
    const message = decodeURIComponent(encodedMessage);
    
    // Format untuk clipboard (rapi, tanpa HTML)
    const cleanMessage = message
        .replace(/\*\*/g, '') // Hapus **
        .replace(/\*/g, '') // Hapus *
        .replace(/<br>/g, '\n') // Ganti <br> dengan newline
        .replace(/<[^>]*>/g, ''); // Hapus semua tag HTML
    
    navigator.clipboard.writeText(cleanMessage)
        .then(() => {
            // Tampilkan feedback
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
            buttonElement.style.color = 'var(--success-color)';
            
            setTimeout(() => {
                buttonElement.innerHTML = originalHTML;
                buttonElement.style.color = 'var(--primary-color)';
            }, 2000);
            
            showNotification('Pesan AI disalin ke clipboard!', 'success');
        })
        .catch(err => {
            console.error('Gagal menyalin:', err);
            showNotification('Gagal menyalin pesan', 'error');
        });
}

async function initializeApp() {
    console.log('Initializing app...');
    
    try {
        // Load data sederhana
        loadUserData();
        
        // Setup event listeners
        setupEventListeners();
        
        // Update UI
        updateUI();
        
        // Start countdown jika ada challenge
        if (currentChallenge) {
            startCountdown();
        }
        
        // Tes koneksi AI
        setTimeout(async () => {
            try {
                console.log('Testing AI connection...');
                const testResponse = await makeAIRequest("Halo");
                console.log('AI Connection test result:', testResponse.substring(0, 100));
                showNotification('AI Companion siap membantu!', 'success');
            } catch (error) {
                console.warn('AI test failed:', error.message);
                showNotification('AI siap dengan mode fallback', 'info');
            }
        }, 2000);
        
        console.log('App initialized successfully');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        showNotification('App dimuat dengan mode sederhana', 'info');
    }
}

// ============================================
// LOAD USER DATA YANG DIPERBAIKI
// ============================================
function loadUserData() {
    try {
        // Load conversation
        const conversation = localStorage.getItem('ai_conversation');
        if (conversation) {
            aiConversation = JSON.parse(conversation);
            updateAIChatUI();
        }
        
        // Set default user
        currentUser = {
            username: localStorage.getItem('username') || 'Pengguna 90 Hari',
            userId: 'user_' + Date.now()
        };
        
        // Load challenge jika ada
        const challenge = localStorage.getItem('currentChallenge');
        if (challenge) {
            currentChallenge = JSON.parse(challenge);
        }
        
    } catch (error) {
        console.warn('Error loading user data:', error);
        // Set defaults
        aiConversation = [];
        currentUser = { username: 'Pengguna 90 Hari', userId: 'user_' + Date.now() };
    }
}

 function loadUserData() {
    try {
        // Load AI Memory
        const savedMemory = localStorage.getItem('ai_memory');
        if (savedMemory) {
            aiMemory = JSON.parse(savedMemory);
        } else {
            aiMemory = [];
        }
        
        // Load conversation history
        const savedHistory = localStorage.getItem('conversation_history');
        if (savedHistory) {
            conversationHistory = JSON.parse(savedHistory);
        } else {
            conversationHistory = [];
        }
        
        // Load challenge
        const challengeData = localStorage.getItem('currentChallenge');
        if (challengeData) {
            currentChallenge = JSON.parse(challengeData);
        }
        
        // Load daily checklists
        const checklists = localStorage.getItem('dailyChecklists');
        if (checklists) {
            dailyChecklists = JSON.parse(checklists);
        }
        
        // Load weekly reviews
        const weeklies = localStorage.getItem('weeklyReviews');
        if (weeklies) {
            weeklyReviews = JSON.parse(weeklies);
        }
        
        // Load monthly reviews
        const monthlies = localStorage.getItem('monthlyReviews');
        if (monthlies) {
            monthlyReviews = JSON.parse(monthlies);
        }
        
        // Load habits
        const habits = localStorage.getItem('userHabits');
        if (habits) {
            userHabits = JSON.parse(habits);
        } else {
            // Default habits
            userHabits = [
                { id: 1, name: 'Bangun pagi', description: 'Bangun sebelum jam 6 pagi', category: 'discipline', created: new Date().toISOString() },
                { id: 2, name: 'Belajar English/Web', description: 'Belajar bahasa Inggris atau web development', category: 'skill', created: new Date().toISOString() },
                { id: 3, name: 'Olahraga ringan', description: 'Olahraga minimal 15 menit', category: 'health', created: new Date().toISOString() },
                { id: 4, name: 'Fokus kerja', description: 'Fokus kerja minimal 4 jam tanpa gangguan', category: 'discipline', created: new Date().toISOString() },
                { id: 5, name: 'Ibadah', description: 'Melakukan ibadah sesuai agama/keyakinan', category: 'spiritual', created: new Date().toISOString() },
                { id: 6, name: 'Review diri', description: 'Mereview pencapaian dan belajar dari kesalahan', category: 'mental', created: new Date().toISOString() }
            ];
            localStorage.setItem('userHabits', JSON.stringify(userHabits));
        }
        
        // Load AI conversation
        const conversation = localStorage.getItem('ai_conversation');
        if (conversation) {
            aiConversation = JSON.parse(conversation);
            updateAIChatUI();
        } else {
            aiConversation = [];
        }
        
        // Set user info
        currentUser = {
            username: localStorage.getItem('username') || 'Pengguna 90 Hari',
            userId: 'user_' + Date.now()
        };
        
        document.getElementById('settingsUsername').value = currentUser.username;
        document.getElementById('sidebarUsername').textContent = currentUser.username;
        document.getElementById('userAvatar').innerHTML = `<i class="fas fa-user"></i>`;
        
    } catch (error) {
        console.error('Error loading user data:', error);
        // Initialize with default data
        initializeDefaultData();
    }
}
        
        async function initializeApp() {
    try {
        console.log('Initializing 90 Days AI Companion...');
        
        // Load data dari localStorage
        await loadUserData();
        
        // Initialize system state
        systemState.initializeAPIHealth();
        
        // Setup event listeners
        setupEventListeners();
        
        // Update UI
        updateUI();
        
        // Start countdown jika challenge aktif
        if (currentChallenge) {
            startCountdown();
        }
        
        console.log('App initialized successfully');
        
        
    } catch (error) {
        console.error('Failed to initialize app:', error);
        showNotification('Error initializing app. Please refresh.', 'error');
    }
}

        function initializeDefaultData() {
            currentUser = {
                username: 'Pengguna 90 Hari',
                userId: 'user_' + Date.now()
            };
            
            userHabits = [
                { id: 1, name: 'Bangun pagi', description: 'Bangun sebelum jam 6 pagi', category: 'discipline', created: new Date().toISOString() },
                { id: 2, name: 'Belajar English/Web', description: 'Belajar bahasa Inggris atau web development', category: 'skill', created: new Date().toISOString() },
                { id: 3, name: 'Olahraga ringan', description: 'Olahraga minimal 15 menit', category: 'health', created: new Date().toISOString() },
                { id: 4, name: 'Fokus kerja', description: 'Fokus kerja minimal 4 jam tanpa gangguan', category: 'discipline', created: new Date().toISOString() },
                { id: 5, name: 'Ibadah', description: 'Melakukan ibadah sesuai agama/keyakinan', category: 'spiritual', created: new Date().toISOString() },
                { id: 6, name: 'Review diri', description: 'Mereview pencapaian dan belajar dari kesalahan', category: 'mental', created: new Date().toISOString() }
            ];
            
            localStorage.setItem('userHabits', JSON.stringify(userHabits));
            localStorage.setItem('username', currentUser.username);
        }

        // ============================================
        // SETUP EVENT LISTENERS - SIMPLE VERSION
        // ============================================
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Mobile menu
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    navigateTo(page);
                });
            });
            
            // Theme toggle
            themeToggleBtn.addEventListener('click', toggleTheme);
            sidebarThemeToggle.addEventListener('click', toggleTheme);
            
            // Challenge
            startChallengeBtn.addEventListener('click', () => {
                startChallengeModal.classList.remove('hidden');
            });
            
            closeChallengeModal.addEventListener('click', () => {
                startChallengeModal.classList.add('hidden');
            });
            
            confirmStartChallenge.addEventListener('click', startChallenge);
            
            // Refresh motivation
            refreshMotivationBtn.addEventListener('click', updateDailyMotivation);
            
            // View daily details
            document.getElementById('viewDailyDetailsBtn').addEventListener('click', () => {
                navigateTo('daily');
            });
            
            // Daily checklist
            document.getElementById('saveDailyBtn').addEventListener('click', saveDailyProgress);
            document.getElementById('resetDailyBtn').addEventListener('click', resetDailyChecklist);
            
            // Weekly
            document.getElementById('saveWeeklyBtn').addEventListener('click', saveWeeklyReview);
            document.getElementById('generateWeeklyBtn').addEventListener('click', generateWeeklyAI);
            
            // Monthly
            document.getElementById('saveMonthlyBtn').addEventListener('click', saveMonthlyReview);
            document.getElementById('generateMonthlyBtn').addEventListener('click', generateMonthlyAI);
            
            // AI Chat
            document.getElementById('aiSendBtn').addEventListener('click', sendAIMessage);
            document.getElementById('aiChatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });
            
            
            // Update Memory
            document.getElementById('updateMemoryBtn').addEventListener('click', updateAIMemory);
            
            // Habits
            document.getElementById('addHabitBtn').addEventListener('click', addNewHabit);
            
            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('resetDataBtn').addEventListener('click', resetData);
            
            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 992 && 
                    !sidebar.contains(e.target) && 
                    !mobileMenuBtn.contains(e.target) && 
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', handleResize);
            
            console.log('Event listeners setup complete');
        }

        // ============================================
        // FUNGSI UI
        // ============================================
        function navigateTo(page) {
            // Hide all pages
            Object.values(pages).forEach(p => p.classList.remove('active'));
            
            // Show selected page
            pages[page].classList.add('active');
            
            // Update active nav item
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });
            
            // Close sidebar on mobile
            if (window.innerWidth <= 992) {
                sidebar.classList.remove('active');
            }
            
            // Load page data
            loadPageData(page);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            const switchHandle = document.querySelector('.switch-handle');
            if (switchHandle) {
                switchHandle.style.left = isDark ? 'calc(100% - 24px)' : '2px';
            }
            
            // Update charts jika ada
            if (charts.dailyStats) {
                charts.dailyStats.destroy();
                loadDailyStats();
            }
        }

        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'daily':
                    loadDailyData();
                    break;
                case 'weekly':
                    loadWeeklyData();
                    break;
                case 'monthly':
                    loadMonthlyData();
                    break;
                case 'ai':
                    loadAIData();
                    break;
                case 'progress':
                    loadProgressData();
                    break;
                case 'habits':
                    loadHabitsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.toggle('active', button.getAttribute('data-tab') === tab);
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            });
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        function loadDashboardData() {
            loadTodayChecklistPreview();
            updateDailyMotivation();
            updateDashboardAlert();
            updateStreakUI();
        }

        function loadTodayChecklistPreview() {
            const container = document.getElementById('todayChecklistPreview');
            if (!container) return;
            
            container.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            let todayChecklist = dailyChecklists.find(c => c.date === today);
            
            if (!todayChecklist) {
                todayChecklist = {
                    date: today,
                    completed: false,
                    items: [
                        { id: 1, name: 'Bangun pagi', completed: false, time: '06:00' },
                        { id: 2, name: 'Belajar English/Web', completed: false, time: '09:00' },
                        { id: 3, name: 'Olahraga ringan', completed: false, time: '17:00' },
                        { id: 4, name: 'Fokus kerja', completed: false, time: '10:00' },
                        { id: 5, name: 'Ibadah', completed: false, time: '18:00' },
                        { id: 6, name: 'Review diri', completed: false, time: '21:00' }
                    ]
                };
            }
            
            const itemsToShow = todayChecklist.items.slice(0, 3);
            
            itemsToShow.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'checklist-item';
                itemElement.innerHTML = `
                    <div class="checklist-checkbox ${item.completed ? 'checked' : ''}">
                        ${item.completed ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="checklist-text">${item.name}</div>
                    <div class="checklist-time">${item.time}</div>
                `;
                container.appendChild(itemElement);
            });
            
            if (todayChecklist.items.length > 3) {
                const moreElement = document.createElement('div');
                moreElement.className = 'text-center mt-10';
                moreElement.innerHTML = `<span style="color: var(--gray-color);">+${todayChecklist.items.length - 3} aktivitas lainnya</span>`;
                container.appendChild(moreElement);
            }
            
            const completedCount = todayChecklist.items.filter(item => item.completed).length;
            const totalCount = todayChecklist.items.length;
            const completionPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            const progressIndicator = document.createElement('div');
            progressIndicator.className = 'progress-container mt-20';
            progressIndicator.innerHTML = `
                <div class="progress-label">
                    <span>Progress Hari Ini</span>
                    <span>${completionPercent}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${completionPercent}%"></div>
                </div>
            `;
            container.appendChild(progressIndicator);
        }

        function updateDailyMotivation() {
            const motivations = [
                "Konsistensi adalah kunci dari semua kesuksesan. Lakukan sedikit setiap hari.",
                "Hari ini adalah kesempatan untuk menjadi versi terbaik dari dirimu.",
                "Proses kecil yang dilakukan setiap hari akan menghasilkan hasil yang besar.",
                "Disiplin adalah jembatan antara tujuan dan pencapaian.",
                "Jangan bandingkan babak 1 perjalananmu dengan babak 10 perjalanan orang lain.",
                "Satu-satunya batasan untuk meraih mimpi adalah keraguanmu hari ini.",
                "Kemajuan sekecil apapun tetap merupakan kemajuan.",
                "Fokus pada proses, hasil akan mengikuti.",
                "Kualitas hidupmu ditentukan oleh kualitas kebiasaan harianmu.",
                "Mulailah dari mana kamu berada. Gunakan apa yang kamu miliki. Lakukan apa yang kamu bisa."
            ];
            
            const randomIndex = Math.floor(Math.random() * motivations.length);
            const dailyMotivation = document.getElementById('dailyMotivation');
            if (dailyMotivation) {
                dailyMotivation.textContent = `"${motivations[randomIndex]}"`;
            }
        }

        function updateDashboardAlert() {
            const today = new Date().toISOString().split('T')[0];
            const todayChecklist = dailyChecklists.find(c => c.date === today);
            const dashboardAlert = document.getElementById('dashboardAlert');
            
            if (dashboardAlert) {
                if (todayChecklist && todayChecklist.completed) {
                    dashboardAlert.classList.remove('hidden');
                } else {
                    dashboardAlert.classList.add('hidden');
                }
            }
        }

        // ============================================
        // CHALLENGE SYSTEM
        // ============================================
        function startChallenge() {
            const target = document.getElementById('challengeTarget').value.trim();
            const why = document.getElementById('challengeWhy').value.trim();
            
            if (!target) {
                showNotification('Masukkan target utama Anda', 'error');
                return;
            }
            
            currentChallenge = {
                startDate: new Date().toISOString(),
                target: target,
                why: why,
                day: 1
            };
            
            localStorage.setItem('currentChallenge', JSON.stringify(currentChallenge));
            
            // Close modal
            startChallengeModal.classList.add('hidden');
            
            // Update UI
            updateChallengeUI();
            updateAIMemoryUI();
            
            // Start countdown
            startCountdown();
            
            showNotification('Challenge 90 hari dimulai!', 'success');
        }

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                updateChallengeUI();
            }, 1000);
        }

        function updateChallengeUI() {
            if (!currentChallenge) return;
            
            const startDate = new Date(currentChallenge.startDate);
            const now = new Date();
            const diffTime = now - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const currentDay = Math.min(diffDays + 1, 90);
            
            document.getElementById('currentDay').textContent = currentDay;
            
            const progressPercent = Math.min((currentDay / 90) * 100, 100);
            document.getElementById('totalProgressPercent').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('totalProgressFill').style.width = `${progressPercent}%`;
            
            document.getElementById('challengeProgressPercent').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('challengeProgressFill').style.width = `${progressPercent}%`;
            
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 90);
            document.getElementById('challengeEndDate').textContent = endDate.toLocaleDateString('id-ID');
            
            updateCountdown(endDate);
            
            const currentWeek = Math.ceil(currentDay / 7);
            const currentMonth = Math.ceil(currentDay / 30);
            document.getElementById('currentWeek').textContent = currentWeek;
            document.getElementById('currentMonth').textContent = currentMonth;
        }

        function updateCountdown(endDate) {
            const now = new Date();
            const timeRemaining = endDate - now;
            
            if (timeRemaining <= 0) {
                document.getElementById('countdownDays').textContent = '0';
                document.getElementById('countdownHours').textContent = '0';
                document.getElementById('countdownMinutes').textContent = '0';
                document.getElementById('countdownSeconds').textContent = '0';
                clearInterval(countdownInterval);
                return;
            }
            
            const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
            
            document.getElementById('countdownDays').textContent = days;
            document.getElementById('countdownHours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('countdownMinutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('countdownSeconds').textContent = seconds.toString().padStart(2, '0');
        }

        // ============================================
        // STREAK SYSTEM
        // ============================================
        function updateStreakUI() {
            if (!dailyChecklists || dailyChecklists.length === 0) {
                document.getElementById('streakCount').textContent = '0';
                document.getElementById('sidebarStreak').textContent = '0';
                document.getElementById('headerStreak').textContent = '0';
                document.getElementById('streakMessage').textContent = 'Mulai streak Anda hari ini!';
                return;
            }
            
            const sortedChecklists = [...dailyChecklists].sort((a, b) => new Date(b.date) - new Date(a.date));
            let streak = 0;
            let currentDate = new Date();
            
            const todayStr = currentDate.toISOString().split('T')[0];
            const todayChecklist = sortedChecklists.find(c => c.date === todayStr);
            if (todayChecklist && todayChecklist.completed) {
                streak++;
            }
            
            for (let i = 1; i <= 90; i++) {
                currentDate.setDate(currentDate.getDate() - 1);
                const dateStr = currentDate.toISOString().split('T')[0];
                const checklist = sortedChecklists.find(c => c.date === dateStr);
                
                if (checklist && checklist.completed) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('streakCount').textContent = streak;
            document.getElementById('sidebarStreak').textContent = streak;
            document.getElementById('headerStreak').textContent = streak;
            
            let message = '';
            if (streak === 0) message = 'Mulai streak Anda hari ini!';
            else if (streak < 3) message = 'Pertahankan streak Anda!';
            else if (streak < 7) message = 'Streak yang bagus! Lanjutkan!';
            else if (streak < 14) message = 'Luar biasa! Anda konsisten!';
            else if (streak < 30) message = 'Fantastis! Streak sudah 2 minggu+!';
            else message = 'Legendaris! Streak sudah sebulan+!';
            
            document.getElementById('streakMessage').textContent = message;
            
            const fireAnimation = document.querySelector('.fire-animation');
            if (fireAnimation) {
                if (streak > 0) {
                    fireAnimation.style.display = 'block';
                } else {
                    fireAnimation.style.display = 'none';
                }
            }
        }

        // ============================================
        // DAILY CHECKLIST SYSTEM
        // ============================================
        function loadDailyData() {
            loadDailyChecklist();
            loadDailyHistory();
            loadDailyStats();
        }

        function loadDailyChecklist() {
            const container = document.getElementById('dailyChecklist');
            if (!container) return;
            
            container.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            let todayChecklist = dailyChecklists.find(c => c.date === today);
            
            if (!todayChecklist) {
                todayChecklist = {
                    date: today,
                    completed: false,
                    items: [
                        { id: 1, name: 'Bangun pagi', completed: false, time: '06:00', category: 'discipline' },
                        { id: 2, name: 'Belajar English/Web', completed: false, time: '09:00', category: 'skill' },
                        { id: 3, name: 'Olahraga ringan', completed: false, time: '17:00', category: 'health' },
                        { id: 4, name: 'Fokus kerja', completed: false, time: '10:00', category: 'discipline' },
                        { id: 5, name: 'Ibadah', completed: false, time: '18:00', category: 'spiritual' },
                        { id: 6, name: 'Review diri', completed: false, time: '21:00', category: 'mental' }
                    ]
                };
                
                dailyChecklists.push(todayChecklist);
                localStorage.setItem('dailyChecklists', JSON.stringify(dailyChecklists));
            }
            
            todayChecklist.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'checklist-item';
                itemElement.innerHTML = `
                    <div class="checklist-checkbox ${item.completed ? 'checked' : ''}" data-id="${item.id}">
                        ${item.completed ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="checklist-text">
                        <div>${item.name}</div>
                        <small style="color: var(--gray-color); font-size: 0.8rem;">${getCategoryName(item.category)}</small>
                    </div>
                    <div class="checklist-time">${item.time}</div>
                `;
                
                const checkbox = itemElement.querySelector('.checklist-checkbox');
                checkbox.addEventListener('click', () => {
                    item.completed = !item.completed;
                    checkbox.classList.toggle('checked');
                    checkbox.innerHTML = item.completed ? '<i class="fas fa-check"></i>' : '';
                    
                    const checklistIndex = dailyChecklists.findIndex(c => c.date === today);
                    if (checklistIndex !== -1) {
                        const itemIndex = dailyChecklists[checklistIndex].items.findIndex(i => i.id === item.id);
                        if (itemIndex !== -1) {
                            dailyChecklists[checklistIndex].items[itemIndex].completed = item.completed;
                            localStorage.setItem('dailyChecklists', JSON.stringify(dailyChecklists));
                        }
                    }
                    
                    updateStreakUI();
                    updateDashboardAlert();
                });
                
                container.appendChild(itemElement);
            });
        }

        function getCategoryName(category) {
            const categories = {
                discipline: 'Disiplin',
                skill: 'Skill Development',
                health: 'Kesehatan',
                mental: 'Mental Growth',
                spiritual: 'Spiritual Growth',
                income: 'Income'
            };
            return categories[category] || category;
        }

        function loadDailyHistory() {
            const container = document.getElementById('dailyHistory');
            if (!container) return;
            
            if (dailyChecklists.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--gray-color); padding: 40px;">
                        <i class="fas fa-history fa-2x mb-10"></i><br>
                        Belum ada riwayat harian
                    </p>
                `;
                return;
            }
            
            const sortedChecklists = [...dailyChecklists].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let historyHTML = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            sortedChecklists.forEach(checklist => {
                const date = new Date(checklist.date);
                const dateStr = date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                const completedCount = checklist.items.filter(item => item.completed).length;
                const totalCount = checklist.items.length;
                const completionPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                
                historyHTML += `
                    <div style="padding: 15px; background-color: var(--light-color); border-radius: var(--border-radius);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: 600;">${dateStr}</div>
                            <div style="color: ${completionPercent === 100 ? 'var(--success-color)' : completionPercent >= 50 ? 'var(--primary-color)' : 'var(--warning-color)'}; font-weight: 600;">
                                ${completionPercent}%
                            </div>
                        </div>
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill" style="width: ${completionPercent}%; background-color: ${completionPercent === 100 ? 'var(--success-color)' : completionPercent >= 50 ? 'var(--primary-color)' : 'var(--warning-color)'};"></div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray-color); margin-top: 8px;">
                            ${completedCount} dari ${totalCount} aktivitas selesai
                        </div>
                    </div>
                `;
            });
            
            historyHTML += '</div>';
            container.innerHTML = historyHTML;
        }

        function loadDailyStats() {
            const ctx = document.getElementById('dailyStatsChart');
            if (!ctx) return;
            
            const ctx2d = ctx.getContext('2d');
            
            if (charts.dailyStats) {
                charts.dailyStats.destroy();
            }
            
            const last7Days = [];
            const completionData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const checklist = dailyChecklists.find(c => c.date === dateStr);
                let completionPercent = 0;
                
                if (checklist && checklist.items.length > 0) {
                    const completedCount = checklist.items.filter(item => item.completed).length;
                    completionPercent = Math.round((completedCount / checklist.items.length) * 100);
                }
                
                last7Days.push(date.toLocaleDateString('id-ID', { weekday: 'short' }));
                completionData.push(completionPercent);
            }
            
            charts.dailyStats = new Chart(ctx2d, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Persentase Penyelesaian',
                        data: completionData,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--text-color)'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'var(--text-color)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-color)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        function saveDailyProgress() {
            const today = new Date().toISOString().split('T')[0];
            const checklistIndex = dailyChecklists.findIndex(c => c.date === today);
            
            if (checklistIndex !== -1) {
                const checklist = dailyChecklists[checklistIndex];
                const completedCount = checklist.items.filter(item => item.completed).length;
                const totalCount = checklist.items.length;
                
                checklist.completed = completedCount === totalCount;
                
                localStorage.setItem('dailyChecklists', JSON.stringify(dailyChecklists));
                
                updateStreakUI();
                updateDashboardAlert();
                
                if (checklist.completed) {
                    showNotification('Selamat! Anda telah menyelesaikan semua checklist hari ini.', 'success');
                } else {
                    showNotification('Progress harian berhasil disimpan.', 'success');
                }
                
                updateAIMemory();
            }
        }

        function resetDailyChecklist() {
            if (confirm('Apakah Anda yakin ingin mereset checklist hari ini?')) {
                const today = new Date().toISOString().split('T')[0];
                const checklistIndex = dailyChecklists.findIndex(c => c.date === today);
                
                if (checklistIndex !== -1) {
                    dailyChecklists[checklistIndex].items.forEach(item => {
                        item.completed = false;
                    });
                    dailyChecklists[checklistIndex].completed = false;
                    
                    localStorage.setItem('dailyChecklists', JSON.stringify(dailyChecklists));
                    
                    loadDailyChecklist();
                    updateStreakUI();
                    
                    showNotification('Checklist hari ini telah direset.', 'info');
                }
            }
        }

        // ============================================
        // WEEKLY SYSTEM
        // ============================================
        function loadWeeklyData() {
            loadWeeklyHistory();
        }

        function saveWeeklyReview() {
            const good = document.getElementById('weeklyGood').value.trim();
            const improve = document.getElementById('weeklyImprove').value.trim();
            const plan = document.getElementById('weeklyPlan').value.trim();
            const skills = document.getElementById('weeklySkills').value.trim();
            
            if (!good && !improve && !plan && !skills) {
                showNotification('Isi minimal satu field untuk menyimpan review.', 'error');
                return;
            }
            
            const review = {
                date: new Date().toISOString(),
                good: good,
                improve: improve,
                plan: plan,
                skills: skills,
                weekNumber: currentChallenge ? Math.ceil((new Date() - new Date(currentChallenge.startDate)) / (1000 * 60 * 60 * 24 * 7)) : 1
            };
            
            weeklyReviews.push(review);
            localStorage.setItem('weeklyReviews', JSON.stringify(weeklyReviews));
            
            updateAIMemory();
            loadWeeklyHistory();
            
            document.getElementById('weeklyGood').value = '';
            document.getElementById('weeklyImprove').value = '';
            document.getElementById('weeklyPlan').value = '';
            document.getElementById('weeklySkills').value = '';
            
            showNotification('Review mingguan berhasil disimpan.', 'success');
        }

       // ============================================
// ENHANCED WEEKLY REVIEW AI GENERATION
// ============================================
async function generateWeeklyAI() {
    showLoading(true);
    
    // Collect user data for context
    const weeklyData = {
        good: document.getElementById('weeklyGood').value.trim(),
        improve: document.getElementById('weeklyImprove').value.trim(),
        plan: document.getElementById('weeklyPlan').value.trim(),
        skills: document.getElementById('weeklySkills').value.trim(),
        weekNumber: document.getElementById('currentWeek').textContent || "1"
    };
    
    // Collect user progress data
    const progressData = {
        currentDay: document.getElementById('currentDay').textContent || "1",
        streak: document.getElementById('streakCount').textContent || "0",
        challengeTarget: currentChallenge?.target || "Belum diatur"
    };
    
    // Get daily completion rate for the week
    const weeklyCompletion = calculateWeeklyCompletion();
    
    // Build comprehensive prompt for AI
    const aiPrompt = `ANALISIS REVIEW MINGGUAN - MINGGU KE-${weeklyData.weekNumber}

DATA USER:
- Target 90 Hari: ${progressData.challengeTarget}
- Hari ke: ${progressData.currentDay}
- Streak: ${progressData.streak} hari
- Tingkat Penyelesaian Minggu Ini: ${weeklyCompletion}%

REVIEW USER:
1. YANG BERJALAN BAIK: ${weeklyData.good || "Belum dicatat"}
2. PERLU PERBAIKAN: ${weeklyData.improve || "Belum diidentifikasi"}
3. RENCANA MINGGU DEPAN: ${weeklyData.plan || "Belum direncanakan"}
4. EVALUASI SKILL: ${weeklyData.skills || "Belum dievaluasi"}

TUGAS AI:
Sebagai AI Companion dan mentor, berikan ANALISIS LENGKAP dan SARAN PERSONAL untuk user berdasarkan data di atas. Fokus pada:

1. ANALISIS KEMAJUAN: Evaluasi progress minggu ini berdasarkan data yang ada
2. IDENTIFIKASI POLA: Temukan pola keberhasilan dan tantangan
3. REKOMENDASI KONKRET: Berikan 3-5 rekomendasi spesifik untuk minggu depan
4. ACTION PLAN: Buat rencana aksi harian untuk 7 hari ke depan
5. MOTIVASI: Berikan motivasi yang relevan dengan kondisi user

FORMAT OUTPUT:
- Gunakan bahasa Indonesia yang jelas dan personal
- Sertakan data spesifik user dalam analisis
- Gunakan format bullet points untuk rekomendasi
- Berikan estimasi waktu untuk setiap action item
- Akhiri dengan kalimat motivasi yang kuat

RESPONSE HARUS LENGKAP DAN UTUH. JANGAN POTONG DI TENGAH KALIMAT.`;

    navigateTo('ai');
    
    try {
        // Use long response mode for comprehensive analysis
        const aiResponse = await makeAIRequest(aiPrompt, true);
        
        // Save to conversation history
        aiConversation.push({ 
            role: 'assistant', 
            content: aiResponse,
            context: 'weekly_review',
            timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
        
        // Update AI memory with weekly insights
        updateAIMemoryFromWeekly(weeklyData, aiResponse);
        
        // Display the AI response
        addAIMessage(aiResponse, 'ai');
        
        showNotification('Analisis mingguan berhasil dibuat oleh AI Companion!', 'success');
        
    } catch (error) {
        console.error('Error generating weekly AI:', error);
        const fallbackResponse = `ANALISIS MINGGUAN - MINGGU KE-${weeklyData.weekNumber}

Berdasarkan data yang Anda berikan:

📊 **KEMAJUAN MINGGU INI:**
${weeklyData.good ? `✅ ${weeklyData.good}` : '🔍 Silakan isi bagian "yang berjalan baik" untuk analisis lebih akurat'}

🎯 **REKOMENDASI UNTUK MINGGU DEPAN:**
1. Fokus pada 1-2 area improvement utama
2. Break down target besar menjadi task harian
3. Schedule waktu khusus untuk skill development
4. Track progress harian dengan checklist
5. Celebrate small wins setiap hari

📅 **ACTION PLAN:**
- Senin: Planning & goal setting untuk minggu ini
- Selasa-Kamis: Eksekusi intensif
- Jumat: Mid-week review & adjustment
- Sabtu: Refleksi & learning
- Minggu: Rest & preparation untuk minggu depan

💪 **MOTIVASI:**
"Konsistensi dalam minggu-minggu kecil akan membangun transformasi besar dalam 90 hari. Tetap semangat!"`;
        
        addAIMessage(fallbackResponse, 'ai');
        showNotification('AI memberikan analisis berdasarkan data yang tersedia', 'info');
    } finally {
        showLoading(false);
    }
}

// ============================================
// ENHANCED MONTHLY REVIEW AI GENERATION
// ============================================
async function generateMonthlyAI() {
    showLoading(true);
    
    // Collect user data
    const monthlyData = {
        skillTarget: document.getElementById('monthlySkillTarget').value.trim(),
        incomeIdeas: document.getElementById('monthlyIncomeIdeas').value.trim(),
        newHabits: document.getElementById('monthlyNewHabits').value.trim(),
        achievements: document.getElementById('monthlyAchievements').value.trim(),
        lessons: document.getElementById('monthlyLessons').value.trim(),
        monthNumber: document.getElementById('currentMonth').textContent || "1"
    };
    
    // Get comprehensive progress data
    const progressSummary = {
        totalDays: document.getElementById('progressTotalDays')?.textContent || "0",
        completedDays: document.getElementById('progressCompletedDays')?.textContent || "0",
        completionRate: document.getElementById('progressCompletionRate')?.textContent || "0%",
        currentStreak: document.getElementById('streakCount')?.textContent || "0"
    };
    
    // Get weekly reviews for this month
    const monthlyWeeklies = weeklyReviews.filter(review => {
        const reviewDate = new Date(review.date);
        const now = new Date();
        return reviewDate.getMonth() === now.getMonth() && 
               reviewDate.getFullYear() === now.getFullYear();
    });
    
    // Build AI prompt
    const aiPrompt = `ANALISIS REVIEW BULANAN - BULAN KE-${monthlyData.monthNumber}

DATA KOMPREHENSIF USER:
- Progress 90 Hari: ${progressSummary.completedDays}/${progressSummary.totalDays} hari (${progressSummary.completionRate})
- Streak Terpanjang: ${progressSummary.currentStreak} hari
- Review Mingguan Bulan Ini: ${monthlyWeeklies.length} review

INPUT USER BULAN INI:
1. TARGET SKILL: ${monthlyData.skillTarget || "Belum ditentukan"}
2. IDE INCOME: ${monthlyData.incomeIdeas || "Belum ada ide"}
3. KEBIASAAN BARU: ${monthlyData.newHabits || "Belum ditentukan"}
4. PENCAPAIAN: ${monthlyData.achievements || "Belum dicatat"}
5. PELAJARAN: ${monthlyData.lessons || "Belum direfleksikan"}

TUGAS AI:
Sebagai AI Companion dan strategic coach, berikan ANALISIS BULANAN MENDALAM dan ROADMAP untuk bulan depan. Fokus pada:

1. TREND ANALYSIS: Identifikasi pola progress bulanan
2. SKILL DEVELOPMENT ROADMAP: Rencana pengembangan skill untuk bulan depan
3. INCOME STRATEGY: Evaluasi ide income dan prioritas
4. HABIT FORMATION PLAN: Strategi membangun kebiasaan baru
5. QUARTERLY ALIGNMENT: Pastikan alignment dengan target 90 hari
6. RISK ASSESSMENT: Identifikasi potensi hambatan dan solusi

FORMAT OUTPUT:
- Gunakan struktur laporan profesional namun personal
- Sertakan data kuantitatif dan kualitatif
- Berikan timeline bulanan yang realistic
- Include milestone checkpoints
- Akhiri dengan vision statement untuk bulan depan

RESPONSE HARUS KOMPREHENSIF DAN UTUH. BERIKAN DETAIL YANG MEMADAI.`;

    navigateTo('ai');
    
    try {
        const aiResponse = await makeAIRequest(aiPrompt, true);
        
        // Save to conversation
        aiConversation.push({ 
            role: 'assistant', 
            content: aiResponse,
            context: 'monthly_review',
            timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
        
        // Update AI memory
        updateAIMemoryFromMonthly(monthlyData, aiResponse);
        
        // Display
        addAIMessage(aiResponse, 'ai');
        
        showNotification('Analisis bulanan komprehensif berhasil dibuat!', 'success');
        
    } catch (error) {
        console.error('Error generating monthly AI:', error);
        const fallbackResponse = `REVIEW BULANAN - BULAN KE-${monthlyData.monthNumber}

📈 **PROGRESS BULAN INI:**
- Hari Terselesaikan: ${progressSummary.completedDays} hari
- Tingkat Penyelesaian: ${progressSummary.completionRate}
- Streak Terpanjang: ${progressSummary.currentStreak} hari

🎯 **STRATEGI BULAN DEPAN:**

1. **SKILL DEVELOPMENT:**
   - Fokus pada: ${monthlyData.skillTarget || "Tentukan 1 skill utama"}
   - Time allocation: Minimal 1 jam/hari
   - Measurement: Buat proyek kecil untuk praktek

2. **INCOME EXPLORATION:**
   - Validasi ide: ${monthlyData.incomeIdeas ? "Pilih 1 ide untuk di-test" : "Brainstorm 3 ide potensial"}
   - Action step: Riset pasar & buat MVP
   - Timeline: 2 minggu untuk validasi

3. **HABIT FORMATION:**
   - Target: ${monthlyData.newHabits || "Pilih 1 kebiasaan kecil"}
   - Implementation: 5 menit/hari, tingkatkan bertahap
   - Tracking: Gunakan checklist harian

4. **MONTHLY MILESTONES:**
   - Minggu 1: Planning & setup
   - Minggu 2: Execution intensif
   - Minggu 3: Review & adjustment
   - Minggu 4: Consolidation & preparation

🌟 **VISION UNTUK BULAN DEPAN:**
"Bulan depan adalah kesempatan untuk mempercepat progress menuju target 90 hari. Fokus pada konsistensi dan kualitas eksekusi."`;
        
        addAIMessage(fallbackResponse, 'ai');
        showNotification('AI memberikan roadmap bulanan', 'info');
    } finally {
        showLoading(false);
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================
function calculateWeeklyCompletion() {
    const last7Days = [];
    let totalCompletion = 0;
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        const checklist = dailyChecklists.find(c => c.date === dateStr);
        if (checklist && checklist.items.length > 0) {
            const completedCount = checklist.items.filter(item => item.completed).length;
            totalCompletion += Math.round((completedCount / checklist.items.length) * 100);
        }
    }
    
    return Math.round(totalCompletion / 7) + '%';
}

function updateAIMemoryFromWeekly(weeklyData, aiAnalysis) {
    // Extract key insights from AI analysis for memory
    const insights = {
        type: 'weekly_insight',
        week: weeklyData.weekNumber,
        date: new Date().toISOString(),
        strengths: weeklyData.good,
        improvements: weeklyData.improve,
        aiAnalysis: aiAnalysis.substring(0, 500) // Store first 500 chars
    };
    
    aiMemory.push(insights);
    localStorage.setItem('ai_memory', JSON.stringify(aiMemory));
    
    // Update UI
    updateAIMemoryUI();
}

function updateAIMemoryFromMonthly(monthlyData, aiAnalysis) {
    const insights = {
        type: 'monthly_insight',
        month: monthlyData.monthNumber,
        date: new Date().toISOString(),
        skillTarget: monthlyData.skillTarget,
        incomeIdeas: monthlyData.incomeIdeas,
        aiRoadmap: aiAnalysis.substring(0, 500)
    };
    
    aiMemory.push(insights);
    localStorage.setItem('ai_memory', JSON.stringify(aiMemory));
    
    updateAIMemoryUI();
}

// ============================================
// UPDATE EVENT LISTENERS
// ============================================
// Replace existing event listeners with enhanced ones
function setupEnhancedEventListeners() {
    // Remove old listeners if they exist
    const oldWeeklyBtn = document.getElementById('generateWeeklyBtn');
    const oldMonthlyBtn = document.getElementById('generateMonthlyBtn');
    
    if (oldWeeklyBtn) {
        oldWeeklyBtn.removeEventListener('click', window.oldGenerateWeekly);
        oldWeeklyBtn.addEventListener('click', generateWeeklyAI);
    }
    
    if (oldMonthlyBtn) {
        oldMonthlyBtn.removeEventListener('click', window.oldGenerateMonthly);
        oldMonthlyBtn.addEventListener('click', generateMonthlyAI);
    }
    
    // Store reference to old functions for cleanup
    window.oldGenerateWeekly = generateWeeklyAI;
    window.oldGenerateMonthly = generateMonthlyAI;
}

// Initialize enhanced system
document.addEventListener('DOMContentLoaded', function() {
    setupEnhancedEventListeners();
    console.log('Enhanced AI system initialized');
});

        function loadWeeklyHistory() {
            const container = document.getElementById('weeklyHistoryList');
            if (!container) return;
            
            if (weeklyReviews.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--gray-color); padding: 20px;">
                        Belum ada review mingguan
                    </p>
                `;
                return;
            }
            
            const sortedReviews = [...weeklyReviews].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let historyHTML = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            sortedReviews.forEach((review, index) => {
                const date = new Date(review.date);
                const dateStr = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                const weekNumber = currentChallenge ? Math.ceil((new Date(review.date) - new Date(currentChallenge.startDate)) / (1000 * 60 * 60 * 24 * 7)) : 1;
                
                historyHTML += `
                    <div style="padding: 15px; background-color: var(--light-color); border-radius: var(--border-radius);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: 600;">Minggu ke-${weekNumber} (${dateStr})</div>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="loadWeeklyReview(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div style="color: var(--gray-color); font-size: 0.9rem;">
                            ${review.good.substring(0, 100)}${review.good.length > 100 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            
            historyHTML += '</div>';
            container.innerHTML = historyHTML;
        }

        window.loadWeeklyReview = function(index) {
            const review = weeklyReviews[index];
            
            document.getElementById('weeklyGood').value = review.good;
            document.getElementById('weeklyImprove').value = review.improve;
            document.getElementById('weeklyPlan').value = review.plan;
            document.getElementById('weeklySkills').value = review.skills;
            
            showNotification('Review mingguan dimuat.', 'info');
        };

        // ============================================
        // MONTHLY SYSTEM
        // ============================================
        function loadMonthlyData() {
            loadMonthlyHistory();
        }

        function saveMonthlyReview() {
            const skillTarget = document.getElementById('monthlySkillTarget').value.trim();
            const incomeIdeas = document.getElementById('monthlyIncomeIdeas').value.trim();
            const newHabits = document.getElementById('monthlyNewHabits').value.trim();
            const achievements = document.getElementById('monthlyAchievements').value.trim();
            const lessons = document.getElementById('monthlyLessons').value.trim();
            
            if (!skillTarget && !incomeIdeas && !newHabits && !achievements && !lessons) {
                showNotification('Isi minimal satu field untuk menyimpan review.', 'error');
                return;
            }
            
            const review = {
                date: new Date().toISOString(),
                skillTarget: skillTarget,
                incomeIdeas: incomeIdeas,
                newHabits: newHabits,
                achievements: achievements,
                lessons: lessons,
                monthNumber: currentChallenge ? Math.ceil((new Date() - new Date(currentChallenge.startDate)) / (1000 * 60 * 60 * 24 * 30)) : 1
            };
            
            monthlyReviews.push(review);
            localStorage.setItem('monthlyReviews', JSON.stringify(monthlyReviews));
            
            updateAIMemory();
            loadMonthlyHistory();
            
            document.getElementById('monthlySkillTarget').value = '';
            document.getElementById('monthlyIncomeIdeas').value = '';
            document.getElementById('monthlyNewHabits').value = '';
            document.getElementById('monthlyAchievements').value = '';
            document.getElementById('monthlyLessons').value = '';
            
            showNotification('Review bulanan berhasil disimpan.', 'success');
        }
        
// ============================================
// ENHANCED AI RESPONSE FORMATTER
// ============================================
function formatAIResponse(text) {
    if (!text) return text;
    
    // Preserve original line breaks first
    let formatted = text;
    
    // Step 1: Normalize line breaks
    formatted = formatted.replace(/\r\n/g, '\n');
    formatted = formatted.replace(/\r/g, '\n');
    
    // Step 2: Format numbered lists (1., 2., 3., etc.)
    formatted = formatted.replace(/^(\d+\.\s+.*)$/gm, '<div class="ai-list-item"><span class="ai-number">$1</span></div>');
    
    // Step 3: Format bullet lists (•, -, *, etc.)
    formatted = formatted.replace(/^([•\-\*]\s+.*)$/gm, '<div class="ai-list-item"><span class="ai-bullet">•</span> $1</div>');
    
    // Step 4: Format sections with headers
    formatted = formatted.replace(/^([A-Z][A-Z\s]+:)$/gm, '<div class="ai-section-header">$1</div>');
    
    // Step 5: Format motivational sections
    formatted = formatted.replace(/^([🔥⭐🎯✨]+.*)$/gm, '<div class="ai-motivational">$1</div>');
    
    // Step 6: Format quotes
    formatted = formatted.replace(/^"(.*)"$/gm, '<div class="ai-quote">"$1"</div>');
    
    // Step 7: Convert remaining line breaks to <br>
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Step 8: Wrap in container
    formatted = `<div class="ai-response-container">${formatted}</div>`;
    
    return formatted;
}

// ============================================
// ENHANCED AI MESSAGE DISPLAY
// ============================================
function addAIMessage(message, role, options = {}) {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${role === 'user' ? 'message-user' : 'message-ai'}`;
    
    if (role === 'ai') {
        // Format AI response dengan enhanced formatter
        const formattedMessage = formatAIResponse(message);
        messageElement.innerHTML = `
            <div class="message-content">${formattedMessage}</div>
            <div class="message-actions ${role === 'ai' ? 'visible' : ''}">
                <button class="copy-btn" title="Salin pesan" onclick="copyAIMessage(this, '${encodeURIComponent(message)}')">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="regenerate-btn" title="Regenerasi response" onclick="regenerateAIResponse(this, '${encodeURIComponent(message)}')">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        `;
    } else {
        // User message
        messageElement.textContent = message;
    }
    
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
    
    // Auto-expand textarea if needed
    if (role === 'user') {
        const chatInput = document.getElementById('aiChatInput');
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    }
}

// ============================================
// ENHANCED TYPING INDICATOR WITH PROGRESS
// ============================================
function showTypingIndicator() {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    removeTypingIndicator();
    
    const indicator = document.createElement('div');
    indicator.className = 'ai-typing';
    indicator.id = 'aiTypingIndicator';
    indicator.innerHTML = `
        <div class="ai-avatar-small">
            <i class="fas fa-robot"></i>
        </div>
        <div class="ai-typing-content">
            <div class="ai-typing-text">AI Companion sedang mengetik...</div>
            <div class="ai-typing-dots">
                <div class="ai-typing-dot"></div>
                <div class="ai-typing-dot"></div>
                <div class="ai-typing-dot"></div>
            </div>
            <div class="ai-typing-progress">
                <div class="ai-typing-progress-bar"></div>
            </div>
        </div>
    `;
    
    container.appendChild(indicator);
    container.scrollTop = container.scrollHeight;
    
    // Animate progress bar
    const progressBar = indicator.querySelector('.ai-typing-progress-bar');
    let width = 0;
    const progressInterval = setInterval(() => {
        width += 10;
        progressBar.style.width = `${Math.min(width, 100)}%`;
        if (width >= 100) width = 0;
    }, 500);
    
    indicator.progressInterval = progressInterval;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('aiTypingIndicator');
    if (indicator) {
        if (indicator.progressInterval) {
            clearInterval(indicator.progressInterval);
        }
        indicator.remove();
    }
}

// ============================================
// ENHANCED CSS FOR AI RESPONSE FORMATTING
// ============================================
const aiFormattingCSS = `
    .ai-response-container {
        line-height: 1.6;
        font-size: 0.95rem;
    }
    
    .ai-list-item {
        margin: 8px 0;
        padding-left: 20px;
        position: relative;
    }
    
    .ai-list-item .ai-number {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .ai-list-item .ai-bullet {
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-weight: bold;
    }
    
    .ai-section-header {
        font-weight: 700;
        color: var(--primary-color);
        margin: 15px 0 8px 0;
        padding-bottom: 5px;
        border-bottom: 2px solid rgba(67, 97, 238, 0.2);
    }
    
    .ai-motivational {
        background: linear-gradient(135deg, rgba(247, 37, 133, 0.1), rgba(67, 97, 238, 0.1));
        padding: 12px 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 4px solid var(--warning-color);
        font-weight: 600;
    }
    
    .ai-quote {
        font-style: italic;
        color: var(--gray-color);
        padding: 10px 15px;
        border-left: 3px solid var(--success-color);
        margin: 10px 0;
        background-color: rgba(76, 201, 240, 0.05);
    }
    
    .ai-typing-progress {
        height: 3px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin-top: 8px;
        overflow: hidden;
    }
    
    .ai-typing-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    
    .ai-avatar-small {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        margin-right: 10px;
    }
`;

// Inject CSS
const styleSheet = document.createElement("style");
styleSheet.textContent = aiFormattingCSS;
document.head.appendChild(styleSheet);



        function loadMonthlyHistory() {
            const container = document.getElementById('monthlyHistoryList');
            if (!container) return;
            
            if (monthlyReviews.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--gray-color); padding: 20px;">
                        Belum ada review bulanan
                    </p>
                `;
                return;
            }
            
            const sortedReviews = [...monthlyReviews].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let historyHTML = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            sortedReviews.forEach((review, index) => {
                const date = new Date(review.date);
                const dateStr = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                const monthNumber = currentChallenge ? Math.ceil((new Date(review.date) - new Date(currentChallenge.startDate)) / (1000 * 60 * 60 * 24 * 30)) : 1;
                
                historyHTML += `
                    <div style="padding: 15px; background-color: var(--light-color); border-radius: var(--border-radius);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: 600;">Bulan ke-${monthNumber} (${dateStr})</div>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="loadMonthlyReview(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div style="color: var(--gray-color); font-size: 0.9rem;">
                            ${review.achievements.substring(0, 100)}${review.achievements.length > 100 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            
            historyHTML += '</div>';
            container.innerHTML = historyHTML;
        }

        window.loadMonthlyReview = function(index) {
            const review = monthlyReviews[index];
            
            document.getElementById('monthlySkillTarget').value = review.skillTarget;
            document.getElementById('monthlyIncomeIdeas').value = review.incomeIdeas;
            document.getElementById('monthlyNewHabits').value = review.newHabits;
            document.getElementById('monthlyAchievements').value = review.achievements;
            document.getElementById('monthlyLessons').value = review.lessons;
            
            showNotification('Review bulanan dimuat.', 'info');
        };

        // ============================================
        // AI COMPANION SYSTEM - SIMPLIFIED
        // ============================================
        function loadAIData() {
    // Update memory UI jika ada
    if (document.getElementById('memoryTargets')) {
        updateAIMemoryUI();
    }
    
    // Pastikan chat container ada dan kosong jika tidak ada conversation
    const container = document.getElementById('aiChatMessages');
    if (container && aiConversation.length === 0) {
        container.innerHTML = `
            <div class="message message-ai">
                Halo! Saya AI Companion yang akan mendampingi perjalanan 90 hari transformasi diri Anda. 
                Saya bisa membantu sebagai mentor, motivator, problem solver, dan life coach. 
                Apa yang bisa saya bantu hari ini?
            </div>
        `;
    }
}

function clearAIMemory() {
    if (confirm('Hapus semua memory dan percakapan AI?')) {
        // Clear memory
        aiMemory = [];
        conversationHistory = [];
        aiConversation = [];
        
        // Clear localStorage
        localStorage.removeItem('ai_memory');
        localStorage.removeItem('conversation_history');
        localStorage.removeItem('ai_conversation');
        
        // Update UI
        updateAIMemoryUI();
        updateAIChatUI();
        
        showNotification('Memory AI dan percakapan dihapus', 'success');
    }
}

// ============================================
// UPDATE AI MEMORY UI
// ============================================
function updateAIMemoryUI() {
    if (!document.getElementById('memoryTargets')) return;
    
    // Update dari data real
    document.getElementById('memoryTargets').innerHTML = 
        `Target: <span>${currentChallenge?.target || 'Belum diatur'}</span>`;
    
    document.getElementById('memoryChallenges').innerHTML = 
        `Tantangan: <span>${aiMemory.length > 0 ? 'Ada catatan' : 'Belum ada'}</span>`;
    
    const today = new Date().toISOString().split('T')[0];
    const todayChecklist = dailyChecklists.find(c => c.date === today);
    const completedCount = todayChecklist?.items.filter(item => item.completed).length || 0;
    const totalCount = todayChecklist?.items.length || 0;
    
    document.getElementById('memoryProgress').innerHTML = 
        `Progress Hari Ini: <span>${completedCount}/${totalCount} selesai</span>`;
    
    document.getElementById('memoryAchievements').innerHTML = 
        `Percakapan: <span>${conversationHistory.length} pesan</span>`;
}

        function updateAIMemoryUI() {
            document.getElementById('memoryTargets').innerHTML = `Target: <span class="memory-placeholder">${currentChallenge?.target || 'Belum diatur'}</span>`;
            
            const challenges = weeklyReviews.map(r => r.improve).filter(Boolean);
            document.getElementById('memoryChallenges').innerHTML = `Tantangan: <span class="memory-placeholder">${challenges.length > 0 ? challenges.join(', ') : 'Belum ada'}</span>`;
            
            const today = new Date().toISOString().split('T')[0];
            const todayChecklist = dailyChecklists.find(c => c.date === today);
            let progressText = 'Belum ada';
            if (todayChecklist) {
                const completedCount = todayChecklist.items.filter(item => item.completed).length;
                const totalCount = todayChecklist.items.length;
                const completionPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                progressText = `Hari ini: ${completionPercent}% selesai`;
            }
            document.getElementById('memoryProgress').innerHTML = `Progress: <span class="memory-placeholder">${progressText}</span>`;
            
            const achievements = monthlyReviews.map(r => r.achievements).filter(Boolean);
            document.getElementById('memoryAchievements').innerHTML = `Pencapaian: <span class="memory-placeholder">${achievements.length > 0 ? achievements.join(', ') : 'Belum ada'}</span>`;
        }

        function updateAIMemory() {
            updateAIMemoryUI();
            showNotification('Memory AI diperbarui.', 'success');
        }

        function updateAIChatUI() {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (aiConversation.length === 0) {
        const initialMessage = document.createElement('div');
        initialMessage.className = 'message message-ai';
        initialMessage.textContent = 'Halo! Saya AI Companion yang akan mendampingi perjalanan 90 hari transformasi diri Anda. Saya bisa membantu sebagai mentor, motivator, problem solver, dan life coach. Apa yang bisa saya bantu hari ini?';
        container.appendChild(initialMessage);
        return;
    }
    
    aiConversation.forEach(msg => {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${msg.role === 'user' ? 'message-user' : 'message-ai'}`;
        messageElement.textContent = msg.content;
        container.appendChild(messageElement);
    });
    
    container.scrollTop = container.scrollHeight;
}

async function sendAIMessage() {
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();
    
    if (!message) {
        showNotification('Masukkan pesan terlebih dahulu.', 'error');
        return;
    }
    
    // Tambah pesan user
    addAIMessage(message, 'user');
    input.value = '';
    
    // Tampilkan typing indicator
    showTypingIndicator();
    
    try {
        const response = await makeAIRequest(message);
        
        // Hapus typing indicator
        removeTypingIndicator();
        
        // Tambah pesan AI dengan format rapi
        addAIMessage(response, 'ai');
        
        // Update UI memory
        updateAIMemoryUI();
        
    } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator();
        
        const fallback = getFallbackResponse(message);
        addAIMessage(fallback, 'ai');
    }
}



        function addAIMessage(message, role, useTypingEffect = false) {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    // Jika AI message dan ingin pakai efek typing
    if (role === 'ai' && useTypingEffect) {
        showAIResponseWithTypingEffect(message);
        return;
    }
    
    // Untuk pesan biasa (user message atau tanpa efek)
    const messageElement = document.createElement('div');
    messageElement.className = `message ${role === 'user' ? 'message-user' : 'message-ai'}`;
    messageElement.textContent = message;
    
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
}


        // ============================================
        // PROGRESS SYSTEM
        // ============================================
        function loadProgressData() {
            loadProgressCharts();
            loadProgressSummary();
            loadAchievements();
        }

        function loadProgressCharts() {
            // Daily Completion Chart
            const dailyCtx = document.getElementById('dailyCompletionChart');
            if (!dailyCtx) return;
            
            const dailyCtx2d = dailyCtx.getContext('2d');
            
            if (charts.dailyCompletion) {
                charts.dailyCompletion.destroy();
            }
            
            const last14Days = [];
            const completionData = [];
            
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                
                const checklist = dailyChecklists.find(c => c.date === dateStr);
                let completionPercent = 0;
                
                if (checklist && checklist.items.length > 0) {
                    const completedCount = checklist.items.filter(item => item.completed).length;
                    completionPercent = Math.round((completedCount / checklist.items.length) * 100);
                }
                
                last14Days.push(dayStr);
                completionData.push(completionPercent);
            }
            
            charts.dailyCompletion = new Chart(dailyCtx2d, {
                type: 'bar',
                data: {
                    labels: last14Days,
                    datasets: [{
                        label: 'Penyelesaian Harian (%)',
                        data: completionData,
                        backgroundColor: 'var(--primary-color)',
                        borderColor: 'var(--secondary-color)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--text-color)'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'var(--text-color)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-color)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Category Progress Chart
            const categoryCtx = document.getElementById('categoryProgressChart');
            if (!categoryCtx) return;
            
            const categoryCtx2d = categoryCtx.getContext('2d');
            
            if (charts.categoryProgress) {
                charts.categoryProgress.destroy();
            }
            
            const categories = ['discipline', 'skill', 'health', 'mental', 'spiritual', 'income'];
            const categoryData = [];
            
            categories.forEach(category => {
                let totalItems = 0;
                let completedItems = 0;
                
                dailyChecklists.forEach(checklist => {
                    checklist.items.forEach(item => {
                        if (item.category === category) {
                            totalItems++;
                            if (item.completed) {
                                completedItems++;
                            }
                        }
                    });
                });
                
                const completionPercent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                categoryData.push(completionPercent);
            });
            
            const categoryNames = categories.map(cat => getCategoryName(cat));
            
            charts.categoryProgress = new Chart(categoryCtx2d, {
                type: 'doughnut',
                data: {
                    labels: categoryNames,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: [
                            'rgba(67, 97, 238, 0.8)',
                            'rgba(76, 201, 240, 0.8)',
                            'rgba(247, 37, 133, 0.8)',
                            'rgba(230, 57, 70, 0.8)',
                            'rgba(58, 12, 163, 0.8)',
                            'rgba(255, 107, 53, 0.8)'
                        ],
                        borderColor: [
                            'rgb(67, 97, 238)',
                            'rgb(76, 201, 240)',
                            'rgb(247, 37, 133)',
                            'rgb(230, 57, 70)',
                            'rgb(58, 12, 163)',
                            'rgb(255, 107, 53)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-color)'
                            }
                        }
                    }
                }
            });
        }

        function loadProgressSummary() {
            let totalDays = 0;
            if (currentChallenge) {
                const startDate = new Date(currentChallenge.startDate);
                const now = new Date();
                const diffTime = now - startDate;
                totalDays = Math.min(Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1, 90);
            }
            
            const completedDays = dailyChecklists.filter(checklist => checklist.completed).length;
            const completionRate = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;
            
            document.getElementById('progressTotalDays').textContent = totalDays;
            document.getElementById('progressCompletedDays').textContent = completedDays;
            document.getElementById('progressCompletionRate').textContent = `${completionRate}%`;
        }

        function loadAchievements() {
            const container = document.getElementById('achievementsList');
            if (!container) return;
            
            let achievementsHTML = '';
            
            const totalDays = parseInt(document.getElementById('currentDay').textContent);
            const streak = parseInt(document.getElementById('streakCount').textContent);
            const completedDays = dailyChecklists.filter(checklist => checklist.completed).length;
            
            achievementsHTML += `
                <div class="alert alert-success">
                    <i class="fas fa-trophy"></i>
                    <div>
                        <strong>Pertama Kali!</strong>
                        <p>Anda telah memulai perjalanan 90 hari transformasi diri</p>
                    </div>
                </div>
            `;
            
            if (totalDays >= 7) {
                achievementsHTML += `
                    <div class="alert alert-success">
                        <i class="fas fa-award"></i>
                        <div>
                            <strong>Minggu Pertama!</strong>
                            <p>Anda telah menyelesaikan minggu pertama perjalanan 90 hari</p>
                        </div>
                    </div>
                `;
            }
            
            if (streak >= 7) {
                achievementsHTML += `
                    <div class="alert alert-warning">
                        <i class="fas fa-fire"></i>
                        <div>
                            <strong>Streak 7 Hari!</strong>
                            <p>Anda telah mempertahankan streak selama 7 hari berturut-turut</p>
                        </div>
                    </div>
                `;
            }
            
            if (completedDays >= 10) {
                achievementsHTML += `
                    <div class="alert alert-success">
                        <i class="fas fa-star"></i>
                        <div>
                            <strong>10 Hari Selesai!</strong>
                            <p>Anda telah menyelesaikan checklist harian sebanyak 10 hari</p>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = achievementsHTML;
        }

        // ============================================
        // HABITS SYSTEM
        // ============================================
        function loadHabitsData() {
            loadCoreHabits();
            loadUserHabits();
        }

        function loadCoreHabits() {
            const container = document.getElementById('coreHabitsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            const coreHabits = userHabits.filter(habit => habit.id <= 6);
            
            coreHabits.forEach(habit => {
                const today = new Date().toISOString().split('T')[0];
                const todayChecklist = dailyChecklists.find(c => c.date === today);
                let completed = false;
                
                if (todayChecklist) {
                    const habitItem = todayChecklist.items.find(item => item.name === habit.name);
                    completed = habitItem ? habitItem.completed : false;
                }
                
                const itemElement = document.createElement('div');
                itemElement.className = 'checklist-item';
                itemElement.innerHTML = `
                    <div class="checklist-checkbox ${completed ? 'checked' : ''}">
                        ${completed ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="checklist-text">
                        <div>${habit.name}</div>
                        <small style="color: var(--gray-color); font-size: 0.8rem;">${getCategoryName(habit.category)} - ${habit.description}</small>
                    </div>
                `;
                container.appendChild(itemElement);
            });
        }

        function loadUserHabits() {
            const container = document.getElementById('userHabitsList');
            if (!container) return;
            
            const customHabits = userHabits.filter(habit => habit.id > 6);
            
            if (customHabits.length === 0) {
                container.innerHTML = `
                    <p class="text-center" style="color: var(--gray-color); padding: 20px;">
                        Belum ada kebiasaan yang ditambahkan
                    </p>
                `;
                return;
            }
            
            let habitsHTML = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            customHabits.forEach(habit => {
                let habitStreak = 0;
                const sortedChecklists = [...dailyChecklists].sort((a, b) => new Date(b.date) - new Date(a.date));
                let currentDate = new Date();
                
                const todayStr = currentDate.toISOString().split('T')[0];
                const todayChecklist = sortedChecklists.find(c => c.date === todayStr);
                if (todayChecklist) {
                    const habitItem = todayChecklist.items.find(item => item.name === habit.name);
                    if (habitItem && habitItem.completed) {
                        habitStreak++;
                    }
                }
                
                for (let i = 1; i <= 90; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const checklist = sortedChecklists.find(c => c.date === dateStr);
                    
                    if (checklist) {
                        const habitItem = checklist.items.find(item => item.name === habit.name);
                        if (habitItem && habitItem.completed) {
                            habitStreak++;
                        } else {
                            break;
                        }
                    } else {
                        break;
                    }
                }
                
                habitsHTML += `
                    <div style="padding: 15px; background-color: var(--light-color); border-radius: var(--border-radius);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600;">${habit.name}</div>
                                <div style="color: var(--gray-color); font-size: 0.9rem; margin-top: 5px;">${habit.description}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="color: var(--primary-color); font-weight: 600;">
                                    <i class="fas fa-fire"></i> ${habitStreak} hari
                                </div>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="deleteHabit(${habit.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray-color);">
                            Kategori: ${getCategoryName(habit.category)}
                        </div>
                    </div>
                `;
            });
            
            habitsHTML += '</div>';
            container.innerHTML = habitsHTML;
        }

        function addNewHabit() {
            const name = document.getElementById('newHabitName').value.trim();
            const description = document.getElementById('newHabitDescription').value.trim();
            const category = document.getElementById('newHabitCategory').value;
            
            if (!name) {
                showNotification('Masukkan nama kebiasaan terlebih dahulu.', 'error');
                return;
            }
            
            if (userHabits.some(habit => habit.name === name)) {
                showNotification('Kebiasaan dengan nama yang sama sudah ada.', 'error');
                return;
            }
            
            const newHabit = {
                id: userHabits.length > 0 ? Math.max(...userHabits.map(h => h.id)) + 1 : 7,
                name: name,
                description: description,
                category: category,
                created: new Date().toISOString()
            };
            
            userHabits.push(newHabit);
            localStorage.setItem('userHabits', JSON.stringify(userHabits));
            
            document.getElementById('newHabitName').value = '';
            document.getElementById('newHabitDescription').value = '';
            
            loadUserHabits();
            
            showNotification('Kebiasaan baru berhasil ditambahkan.', 'success');
        }

        window.deleteHabit = function(habitId) {
            if (confirm('Apakah Anda yakin ingin menghapus kebiasaan ini?')) {
                userHabits = userHabits.filter(habit => habit.id !== habitId);
                localStorage.setItem('userHabits', JSON.stringify(userHabits));
                
                loadUserHabits();
                
                showNotification('Kebiasaan berhasil dihapus.', 'success');
            }
        };

        // ============================================
        // SETTINGS SYSTEM
        // ============================================
        function loadSettingsData() {
            document.getElementById('settingsUsername').value = currentUser.username;
            document.getElementById('settingsTarget').value = currentChallenge?.target || '';
            
            const challenges = weeklyReviews.map(r => r.improve).filter(Boolean);
            document.getElementById('settingsImprovement').value = challenges.join(', ') || '';
            
            const notifications = JSON.parse(localStorage.getItem('notifications') || '{"daily": true, "reminders": true, "weekly": true}');
            document.getElementById('settingsNotifications').checked = notifications.daily;
            document.getElementById('settingsReminders').checked = notifications.reminders;
            document.getElementById('settingsWeeklyReview').checked = notifications.weekly;
        }

        function saveSettings() {
            const username = document.getElementById('settingsUsername').value.trim();
            const target = document.getElementById('settingsTarget').value.trim();
            const improvement = document.getElementById('settingsImprovement').value.trim();
            
            if (username !== currentUser.username) {
                currentUser.username = username;
                localStorage.setItem('username', username);
                document.getElementById('sidebarUsername').textContent = username;
            }
            
            if (currentChallenge && target) {
                currentChallenge.target = target;
                localStorage.setItem('currentChallenge', JSON.stringify(currentChallenge));
            }
            
            const notifications = {
                daily: document.getElementById('settingsNotifications').checked,
                reminders: document.getElementById('settingsReminders').checked,
                weekly: document.getElementById('settingsWeeklyReview').checked
            };
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            updateAIMemoryUI();
            
            showNotification('Pengaturan berhasil disimpan.', 'success');
        }

        function exportData() {
            const data = {
                user: currentUser,
                challenge: currentChallenge,
                dailyChecklists: dailyChecklists,
                weeklyReviews: weeklyReviews,
                monthlyReviews: monthlyReviews,
                habits: userHabits,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `90days-data-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data berhasil diekspor.', 'success');
        }

        function resetData() {
            if (confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan.')) {
                localStorage.clear();
                
                currentChallenge = null;
                dailyChecklists = [];
                weeklyReviews = [];
                monthlyReviews = [];
                userHabits = [];
                aiConversation = [];
                
                initializeDefaultData();
                updateUI();
                navigateTo('dashboard');
                
                showNotification('Semua data telah direset.', 'success');
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showLoading(show) {
    if (!loadingOverlay) return;
    
    if (show) {
        loadingOverlay.classList.remove('hidden');
    } else {
        loadingOverlay.classList.add('hidden');
    }
}

        function showNotification(message, type = 'info') {
            const notificationContainer = document.getElementById('notificationContainer');
            if (!notificationContainer) return;
            
            const notification = document.createElement('div');
            notification.className = `notification`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background-color: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : type === 'warning' ? 'var(--warning-color)' : 'var(--primary-color)'};
                color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div>${message}</div>
            `;
            
            notificationContainer.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        // ============================================
// TYPING INDICATOR FUNCTIONS
// ============================================
let typingInterval = null;
let typingIndicator = null;

function showTypingIndicator() {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    // Hapus indicator sebelumnya jika ada
    removeTypingIndicator();
    
    // Buat typing indicator
    typingIndicator = document.createElement('div');
    typingIndicator.className = 'ai-typing';
    typingIndicator.id = 'aiTypingIndicator';
    typingIndicator.innerHTML = `
        <div class="ai-typing-text">AI sedang mengetik</div>
        <div class="ai-typing-dots">
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
        </div>
    `;
    
    container.appendChild(typingIndicator);
    container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.remove();
        typingIndicator = null;
    }
}

function showAIResponseWithTypingEffect(message, callback) {
    const container = document.getElementById('aiChatMessages');
    if (!container) return;
    
    // Hapus typing indicator
    removeTypingIndicator();
    
    // Buat elemen untuk pesan AI
    const messageElement = document.createElement('div');
    messageElement.className = 'message message-ai';
    messageElement.style.opacity = '0';
    messageElement.style.transform = 'translateY(10px)';
    
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
    
    // Simulasi efek mengetik
    let index = 0;
    const typingSpeed = 20; // ms per karakter
    
    function typeCharacter() {
        if (index < message.length) {
            messageElement.textContent = message.substring(0, index + 1);
            index++;
            typingInterval = setTimeout(typeCharacter, typingSpeed);
            
            // Scroll ke bawah setiap beberapa karakter
            if (index % 10 === 0) {
                container.scrollTop = container.scrollHeight;
            }
        } else {
            // Animasi fade in selesai
            messageElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            messageElement.style.opacity = '1';
            messageElement.style.transform = 'translateY(0)';
            
            clearTimeout(typingInterval);
            typingInterval = null;
            
            // Panggil callback jika ada
            if (callback) callback();
        }
    }
    
    // Mulai efek mengetik setelah delay kecil
    setTimeout(() => {
        typeCharacter();
    }, 300);
}

        function handleResize() {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('active');
            }
        }

        function updateUI() {
            if (currentUser) {
                document.getElementById('sidebarUsername').textContent = currentUser.username;
            }
            
            if (currentChallenge) {
                updateChallengeUI();
            }
            
            updateStreakUI();
            
            // Load theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const switchHandle = document.querySelector('.switch-handle');
                if (switchHandle) {
                    switchHandle.style.left = 'calc(100% - 24px)';
                }
            }
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, initializing app...');
            initializeApp();
        });
    </script>
</body>
</html>
